<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>John Ruben Solutions - Advanced Tracker</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut, createUserWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, where, onSnapshot, deleteDoc, doc, setDoc, getDoc, orderBy, serverTimestamp, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        
        const firebaseConfig = {
            apiKey: "AIzaSyD2h_sejv6lB8sFC15xHSgqxfdD2hLd5Kg",
            authDomain: "john-ruben-solutions.firebaseapp.com",
            projectId: "john-ruben-solutions",
            storageBucket: "john-ruben-solutions.firebasestorage.app",
            messagingSenderId: "761855596159",
            appId: "1:761855596159:web:a4bbe805663c2304c5d14a",
            measurementId: "G-1T2J8VR066"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        window.fb = { auth, db, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut, collection, addDoc, query, where, onSnapshot, deleteDoc, doc, setDoc, getDoc, getDocs, orderBy, serverTimestamp };
    </script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        brand: { navy: '#0f172a', dark: '#020617', card: '#1e293b', green: '#84cc16', teal: '#22d3ee', input: '#334155' }
                    },
                    fontFamily: { sans: ['"Plus Jakarta Sans"', 'sans-serif'] }
                }
            }
        }
    </script>
    <style> 
        body { background-color: #0f172a; color: #f8fafc; } 
        #reader video { object-fit: cover; border-radius: 12px; }
        .table-scroll::-webkit-scrollbar { height: 4px; width: 4px; }
        .table-scroll::-webkit-scrollbar-thumb { background: #84cc16; border-radius: 4px; }
        .table-scroll::-webkit-scrollbar-track { background: #1e293b; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;
        const API_KEY = '4FRpc4urF9W2UedPH6agara8y52PR0efkZRmoPvv'; 

        // --- HELPER: GET WEEK NUMBER ---
        const getWeekNumber = (d) => {
            d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
            d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay() || 7));
            const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
            const weekNo = Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
            return `W${weekNo} - ${d.getUTCFullYear()}`;
        };

        // --- AUTH COMPONENT ---
        const AuthScreen = () => {
            const [isRegister, setIsRegister] = useState(false);
            const [email, setEmail] = useState("");
            const [password, setPassword] = useState("");
            const [error, setError] = useState("");
            const handleSubmit = async (e) => {
                e.preventDefault(); setError("");
                if(!window.fb) return setError("Firebase loading...");
                try {
                    if (isRegister) await window.fb.createUserWithEmailAndPassword(window.fb.auth, email, password);
                    else await window.fb.signInWithEmailAndPassword(window.fb.auth, email, password);
                } catch (err) { setError(err.message); }
            };
            return (
                <div className="min-h-screen flex items-center justify-center p-4">
                    <div className="bg-brand-card p-8 rounded-3xl w-full max-w-sm border border-slate-700">
                        <h2 className="text-xl font-bold text-white mb-6 text-center">{isRegister ? "Create Account" : "Tracker Login"}</h2>
                        <form onSubmit={handleSubmit}>
                            <input type="email" placeholder="Email" className="w-full p-3 mb-4 bg-brand-input rounded-xl text-white outline-none focus:border-brand-green border border-transparent" value={email} onChange={e=>setEmail(e.target.value)} />
                            <input type="password" placeholder="Password" className="w-full p-3 mb-6 bg-brand-input rounded-xl text-white outline-none focus:border-brand-green border border-transparent" value={password} onChange={e=>setPassword(e.target.value)} />
                            {error && <p className="text-red-500 text-xs mb-4 text-center">{error}</p>}
                            <button type="submit" className="w-full py-3 bg-brand-green text-brand-navy font-bold rounded-xl">{isRegister ? "Sign Up" : "Log In"}</button>
                        </form>
                        <button onClick={()=>setIsRegister(!isRegister)} className="w-full mt-4 text-xs text-slate-400 hover:text-white underline">{isRegister ? "Already have an account? Log In" : "Need account? Sign Up"}</button>
                    </div>
                </div>
            );
        };

        const App = () => {
            const [user, setUser] = useState(null);
            const [view, setView] = useState("daily"); // 'daily' or 'trends'
            const [targets, setTargets] = useState({ calories: 2000, protein: 150, carbs: 200, fat: 60 });
            const [query, setQuery] = useState("");
            const [results, setResults] = useState([]);
            const [currentDate, setCurrentDate] = useState(new Date().toISOString().split('T')[0]);
            const [log, setLog] = useState([]);
            const [dailyWeight, setDailyWeight] = useState("");
            const [selectedFood, setSelectedFood] = useState(null);
            const [displayAmount, setDisplayAmount] = useState(100);
            const [measureUnit, setMeasureUnit] = useState('g');
            const [isScanning, setIsScanning] = useState(false);
            const [loading, setLoading] = useState(false);
            const scannerRef = useRef(null);
            const chartRef = useRef(null); 

            // --- INIT ---
            useEffect(() => {
                const check = setInterval(() => {
                    if (window.fb) {
                        clearInterval(check);
                        window.fb.onAuthStateChanged(window.fb.auth, (u) => {
                            setUser(u);
                            if(u) loadTargets(u.uid);
                        });
                    }
                }, 500);
                return () => clearInterval(check);
            }, []);

            const loadTargets = async (uid) => {
                const docRef = window.fb.doc(window.fb.db, "users", uid, "data", "targets");
                const snap = await window.fb.getDoc(docRef);
                if (snap.exists()) setTargets(snap.data());
            };

            // --- DATA FETCHING (Single Day) ---
            useEffect(() => {
                if (!user || !window.fb) return;
                
                // Real-time Daily Log
                const q = window.fb.query(window.fb.collection(window.fb.db, "users", user.uid, "logs"), window.fb.where("date", "==", currentDate));
                const unsub = window.fb.onSnapshot(q, (snap) => {
                    const raw = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                    raw.sort((a,b) => (a.createdAt?.seconds || 0) - (b.createdAt?.seconds || 0)); // Ascending time
                    setLog(raw);
                });
                
                // Daily Weight
                const fetchWeight = async () => {
                    const docRef = window.fb.doc(window.fb.db, "users", user.uid, "daily_stats", currentDate);
                    const docSnap = await window.fb.getDoc(docRef);
                    setDailyWeight(docSnap.exists() ? docSnap.data().weight : "");
                };
                fetchWeight();
                return () => unsub();
            }, [user, currentDate]);

            // --- CHART RENDERING ---
            useEffect(() => {
                if (view === 'trends' && user && chartRef.current) {
                    renderTrendChart();
                }
            }, [view, user]);

            const renderTrendChart = async () => {
                const logSnap = await window.fb.getDocs(window.fb.collection(window.fb.db, "users", user.uid, "logs"));
                const weightSnap = await window.fb.getDocs(window.fb.collection(window.fb.db, "users", user.uid, "daily_stats"));
                
                // 1. Calculate Daily Totals
                const dailyData = {}; 
                logSnap.forEach(doc => {
                    const d = doc.data();
                    if(!dailyData[d.date]) dailyData[d.date] = { cals: 0, weight: null };
                    dailyData[d.date].cals += d.calories;
                });
                weightSnap.forEach(doc => {
                    const d = doc.data();
                    if(!dailyData[d.date]) dailyData[d.date] = { cals: 0, weight: null };
                    dailyData[d.date].weight = parseFloat(d.weight);
                });

                // 2. Aggregate into Weeks
                const weeklyData = {};
                Object.keys(dailyData).forEach(dateStr => {
                    const weekKey = getWeekNumber(new Date(dateStr));
                    if(!weeklyData[weekKey]) weeklyData[weekKey] = { totalCals: 0, daysWithCals: 0, totalWeight: 0, daysWithWeight: 0 };
                    
                    if(dailyData[dateStr].cals > 0) {
                        weeklyData[weekKey].totalCals += dailyData[dateStr].cals;
                        weeklyData[weekKey].daysWithCals++;
                    }
                    if(dailyData[dateStr].weight > 0) {
                        weeklyData[weekKey].totalWeight += dailyData[dateStr].weight;
                        weeklyData[weekKey].daysWithWeight++;
                    }
                });

                // 3. Sort & Average
                const sortedWeeks = Object.keys(weeklyData).sort(); // Sorts by string, works generally for "W1 - 2026" vs "W2"
                const labels = sortedWeeks;
                const avgCals = sortedWeeks.map(w => weeklyData[w].daysWithCals ? weeklyData[w].totalCals / weeklyData[w].daysWithCals : 0);
                const avgWeights = sortedWeeks.map(w => weeklyData[w].daysWithWeight ? weeklyData[w].totalWeight / weeklyData[w].daysWithWeight : null);

                // 4. Render
                if (window.myChart) window.myChart.destroy();
                const ctx = chartRef.current.getContext('2d');
                window.myChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [
                            { label: 'Avg Calories', data: avgCals, borderColor: '#84cc16', yAxisID: 'y', tension: 0.3 },
                            { label: 'Avg Weight (lbs)', data: avgWeights, borderColor: '#22d3ee', yAxisID: 'y1', tension: 0.3 }
                        ]
                    },
                    options: {
                        responsive: true,
                        interaction: { mode: 'index', intersect: false },
                        scales: {
                            y: { type: 'linear', display: true, position: 'left', title: {display: true, text:'Calories'} },
                            y1: { type: 'linear', display: true, position: 'right', grid: { drawOnChartArea: false }, title: {display: true, text:'Weight'} }
                        }
                    }
                });
            };

            // --- FULL HISTORY PDF EXPORT ---
            const exportFullHistory = async () => {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                const navy = [15, 23, 42]; 
                
                doc.setFontSize(18); doc.setTextColor(...navy); doc.text("JOHN RUBEN SOLUTIONS", 14, 20);
                doc.setFontSize(12); doc.setTextColor(100); doc.text(`Full Nutrition History Report`, 14, 28);
                doc.text(`Generated: ${new Date().toLocaleDateString()}`, 14, 34);

                // Fetch ALL Data
                const logSnap = await window.fb.getDocs(window.fb.query(window.fb.collection(window.fb.db, "users", user.uid, "logs"), window.fb.orderBy("date", "desc"), window.fb.orderBy("createdAt", "asc")));
                const weightSnap = await window.fb.getDocs(window.fb.collection(window.fb.db, "users", user.uid, "daily_stats"));
                
                const weights = {};
                weightSnap.forEach(d => weights[d.id] = d.data().weight);

                // Group by Date
                const grouped = {};
                logSnap.forEach(doc => {
                    const d = doc.data();
                    if(!grouped[d.date]) grouped[d.date] = [];
                    grouped[d.date].push(d);
                });

                let finalY = 45;

                // Loop Dates
                Object.keys(grouped).forEach(date => {
                    const items = grouped[date];
                    const dayTotal = items.reduce((acc, i) => ({ cals: acc.cals + i.calories, pro: acc.pro + i.protein, carbs: acc.carbs + i.carbs, fat: acc.fat + i.fat }), { cals: 0, pro: 0, carbs: 0, fat: 0 });
                    
                    // Date Header
                    doc.setFontSize(10);
                    doc.setTextColor(...navy);
                    doc.setFont("helvetica", "bold");
                    doc.text(`Date: ${date}   |   Weight: ${weights[date] ? weights[date] + ' lbs' : 'N/A'}`, 14, finalY);
                    
                    // Table for this day
                    const tableBody = items.map(i => [
                        i.time || '--',
                        i.name.substring(0, 25),
                        Math.round(i.grams) + 'g',
                        Math.round(i.calories),
                        Math.round(i.protein),
                        Math.round(i.carbs),
                        Math.round(i.fat),
                        (i.fiber||0).toFixed(1),
                        (i.o3||0).toFixed(1),
                        (i.o6||0).toFixed(1)
                    ]);
                    
                    // Add Total Row
                    tableBody.push([
                        { content: 'DAILY TOTAL', colSpan: 3, styles: { fontStyle: 'bold' } },
                        Math.round(dayTotal.cals),
                        Math.round(dayTotal.pro),
                        Math.round(dayTotal.carbs),
                        Math.round(dayTotal.fat),
                        '-', '-', '-'
                    ]);

                    doc.autoTable({
                        startY: finalY + 2,
                        head: [['Time', 'Food', 'Weight', 'Cals', 'P', 'C', 'F', 'Fib', '立3', '立6']],
                        body: tableBody,
                        theme: 'grid',
                        headStyles: { fillColor: navy, fontSize: 8 },
                        bodyStyles: { fontSize: 8 },
                        margin: { left: 14, right: 14 }
                    });

                    finalY = doc.lastAutoTable.finalY + 10;
                });
                
                // Weekly Averages Summary at the end
                // Re-calculate averages for summary table
                // (Simplified logic for brevity in PDF generation)
                doc.setFontSize(14);
                doc.text("Weekly Averages Summary", 14, finalY);
                finalY += 5;
                // You can add a specific summary table here if desired based on the aggregated data
                
                doc.save("Full_History_Report.pdf");
            };

            // --- STANDARD SEARCH & ADD ---
            const saveWeight = async () => {
                if (!user) return;
                await window.fb.setDoc(window.fb.doc(window.fb.db, "users", user.uid, "daily_stats", currentDate), { weight: dailyWeight, date: currentDate }, { merge: true });
            };

            const handleSearch = async (e, overrideQuery = null) => {
                if (e) e.preventDefault();
                const qTerm = overrideQuery || query;
                if (!qTerm) return;
                setLoading(true); setResults([]); setSelectedFood(null);

                // Barcode
                if (/^\d+$/.test(qTerm)) {
                    try {
                        let res = await fetch(`https://api.nal.usda.gov/fdc/v1/foods/search?api_key=${API_KEY}&query=${qTerm}&pageSize=1&dataType=Branded,SR Legacy`);
                        let data = await res.json();
                        if (data.foods && data.foods.length > 0) { selectFood(data.foods[0]); setLoading(false); return; }
                        
                        res = await fetch(`https://world.openfoodfacts.org/api/v0/product/${qTerm}.json`);
                        data = await res.json();
                        if(data.status === 1) {
                             const p = data.product;
                             const n = p.nutriments;
                             setSelectedFood({
                                name: p.product_name,
                                calories: n['energy-kcal_100g'] || 0,
                                protein: n.proteins_100g || 0,
                                carbs: n.carbohydrates_100g || 0,
                                fat: n.fat_100g || 0,
                                fiber: n.fiber_100g || 0,
                                o3: n['omega-3-fat_100g'] || 0,
                                o6: n['omega-6-fat_100g'] || 0,
                                userGrams: 100
                             });
                             setQuery(""); setLoading(false); return;
                        }
                    } catch (e) {}
                }

                // Text
                try {
                    const res = await fetch(`https://api.nal.usda.gov/fdc/v1/foods/search?api_key=${API_KEY}&query=${qTerm}&pageSize=10&dataType=Foundation,SR Legacy,Branded`);
                    const data = await res.json();
                    setResults(data.foods);
                } catch (e) {}
                setLoading(false);
            };

            const selectFood = async (food) => {
                if (food.userGrams) return; 
                setLoading(true);
                const res = await fetch(`https://api.nal.usda.gov/fdc/v1/food/${food.fdcId}?api_key=${API_KEY}`);
                const d = await res.json();
                
                const getN = (id) => {
                    const n = d.foodNutrients.find(x => (x.nutrient?.id === id || x.nutrientId === id));
                    return n ? (n.amount || n.value) : 0;
                };

                let o3 = getN(1272) || 0;
                let o6 = getN(1269) || 0;

                setSelectedFood({
                    name: d.description,
                    calories: getN(1008) || getN(208),
                    protein: getN(1003) || getN(203),
                    carbs: getN(1005) || getN(205),
                    fat: getN(1004) || getN(204),
                    fiber: getN(1079) || getN(291),
                    o3: o3,
                    o6: o6,
                    userGrams: 100
                });
                setResults([]); setQuery("");
                setLoading(false);
            };

            const addToLog = async () => {
                if(!selectedFood) return;
                const f = selectedFood.userGrams / 100;
                const time = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                
                const item = {
                    name: selectedFood.name,
                    grams: selectedFood.userGrams,
                    calories: Math.round(selectedFood.calories * f),
                    protein: parseFloat((selectedFood.protein * f).toFixed(1)),
                    carbs: parseFloat((selectedFood.carbs * f).toFixed(1)),
                    fat: parseFloat((selectedFood.fat * f).toFixed(1)),
                    fiber: parseFloat((selectedFood.fiber * f).toFixed(1)),
                    o3: parseFloat((selectedFood.o3 * f).toFixed(2)),
                    o6: parseFloat((selectedFood.o6 * f).toFixed(2)),
                    date: currentDate,
                    time: time,
                    createdAt: window.fb.serverTimestamp()
                };

                await window.fb.addDoc(window.fb.collection(window.fb.db, "users", user.uid, "logs"), item);
                setSelectedFood(null);
            };

            const deleteItem = async (id) => {
                if(confirm("Delete item?")) await window.fb.deleteDoc(window.fb.doc(window.fb.db, "users", user.uid, "logs", id));
            };

            const totals = log.reduce((acc, i) => ({
                cals: acc.cals + i.calories,
                pro: acc.pro + i.protein,
                carb: acc.carb + i.carbs,
                fat: acc.fat + i.fat,
                fib: acc.fib + (i.fiber||0),
                o3: acc.o3 + (i.o3||0),
                o6: acc.o6 + (i.o6||0)
            }), { cals: 0, pro: 0, carb: 0, fat: 0, fib: 0, o3: 0, o6: 0 });

            if (!user) return <AuthScreen />;

            return (
                <div className="max-w-4xl mx-auto px-4 pt-6 pb-20 font-sans text-white">
                    {/* TOP BAR */}
                    <div className="flex justify-between items-center mb-6 border-b border-slate-700 pb-4">
                        <h1 className="text-xl font-bold">Food Tracker</h1>
                        <div className="flex gap-4">
                            <button onClick={()=>setView('daily')} className={`text-xs px-3 py-1 rounded-full ${view==='daily' ? 'bg-brand-green text-brand-navy' : 'text-slate-400'}`}>Daily Log</button>
                            <button onClick={()=>setView('trends')} className={`text-xs px-3 py-1 rounded-full ${view==='trends' ? 'bg-brand-green text-brand-navy' : 'text-slate-400'}`}>Analytics</button>
                            <button onClick={() => window.fb.signOut(window.fb.auth)} className="text-xs text-red-400">Sign Out</button>
                        </div>
                    </div>

                    {/* MACRO DASHBOARD */}
                    <div className="grid grid-cols-2 md:grid-cols-5 gap-2 mb-6 text-center">
                        <div className="bg-brand-card p-3 rounded-xl border border-slate-700">
                            <span className="text-[10px] text-slate-400 uppercase">Calories</span>
                            <div className={`text-lg font-bold ${totals.cals > targets.calories ? 'text-red-400' : 'text-white'}`}>{Math.round(totals.cals)} / {targets.calories}</div>
                        </div>
                        <div className="bg-brand-card p-3 rounded-xl border border-slate-700">
                            <span className="text-[10px] text-brand-teal uppercase">Protein</span>
                            <div className="text-sm font-bold">{Math.round(totals.pro)} / {targets.protein}g</div>
                        </div>
                        <div className="bg-brand-card p-3 rounded-xl border border-slate-700">
                            <span className="text-[10px] text-brand-green uppercase">Carbs</span>
                            <div className="text-sm font-bold">{Math.round(totals.carb)} / {targets.carbs}g</div>
                        </div>
                        <div className="bg-brand-card p-3 rounded-xl border border-slate-700">
                            <span className="text-[10px] text-yellow-400 uppercase">Fat</span>
                            <div className="text-sm font-bold">{Math.round(totals.fat)} / {targets.fat}g</div>
                        </div>
                        <div className="bg-brand-card p-3 rounded-xl border border-slate-700">
                            <span className="text-[10px] text-purple-400 uppercase">Fiber</span>
                            <div className="text-sm font-bold">{Math.round(totals.fib)} / 45g</div>
                        </div>
                    </div>

                    {/* MAIN VIEW */}
                    {view === 'daily' ? (
                        <>
                            {/* DATE & WEIGHT */}
                            <div className="flex flex-col md:flex-row justify-between gap-4 mb-6">
                                <div className="flex items-center bg-brand-card p-2 rounded-xl border border-slate-700">
                                    <button onClick={()=>{const d=new Date(currentDate);d.setDate(d.getDate()-1);setCurrentDate(d.toISOString().split('T')[0])}} className="p-2 hover:text-brand-green">&lt;</button>
                                    <span className="mx-4 font-bold min-w-[100px] text-center">{currentDate}</span>
                                    <button onClick={()=>{const d=new Date(currentDate);d.setDate(d.getDate()+1);setCurrentDate(d.toISOString().split('T')[0])}} className="p-2 hover:text-brand-green">&gt;</button>
                                </div>
                                <div className="flex items-center bg-brand-input rounded-xl px-4 border border-slate-600">
                                    <span className="text-xs text-slate-400 mr-2 uppercase">Weight:</span>
                                    <input type="number" value={dailyWeight} onChange={(e)=>setDailyWeight(e.target.value)} onBlur={saveWeight} className="bg-transparent text-white font-bold w-16 text-right focus:outline-none" placeholder="0.0" />
                                    <span className="text-xs text-brand-green ml-1">lbs</span>
                                </div>
                            </div>

                            {/* SEARCH */}
                            <form onSubmit={handleSearch} className="flex gap-2 mb-6">
                                <input type="text" value={query} onChange={e => setQuery(e.target.value)} placeholder="Search food..." className="flex-1 p-3 bg-brand-input rounded-xl text-white outline-none focus:border-brand-green border border-transparent" />
                                <button type="submit" className="bg-brand-green text-brand-navy px-6 rounded-xl font-bold hover:bg-white transition-colors">Find</button>
                            </form>

                            {/* RESULTS LIST */}
                            {results.length > 0 && (
                                <div className="bg-brand-card rounded-xl border border-slate-700 mb-6 max-h-60 overflow-y-auto">
                                    {results.map(food => (
                                        <div key={food.fdcId} onClick={() => selectFood(food)} className="p-3 border-b border-slate-700 text-slate-300 hover:bg-slate-700 cursor-pointer">
                                            {food.description}
                                        </div>
                                    ))}
                                </div>
                            )}

                            {/* STAGING AREA */}
                            {selectedFood && (
                                <div className="bg-brand-card rounded-2xl border border-slate-700 p-4 mb-6">
                                    <div className="flex justify-between mb-4">
                                        <h3 className="font-bold text-lg">{selectedFood.name}</h3>
                                        <button onClick={()=>setSelectedFood(null)} className="text-slate-500">x</button>
                                    </div>
                                    <div className="flex items-center gap-4 mb-4">
                                        <input type="number" value={displayAmount} onChange={e=>{
                                            setDisplayAmount(e.target.value);
                                            const val = parseFloat(e.target.value)||0;
                                            const g = measureUnit === 'oz' ? val*28.35 : val;
                                            setSelectedFood({...selectedFood, userGrams: g});
                                        }} className="w-20 bg-brand-input text-center p-2 rounded-lg text-white" />
                                        <button onClick={()=>{
                                            const n = measureUnit === 'g' ? 'oz' : 'g';
                                            setMeasureUnit(n);
                                            const val = parseFloat(displayAmount)||0;
                                            const g = n === 'oz' ? val*28.35 : val;
                                            setSelectedFood({...selectedFood, userGrams: g});
                                        }} className="text-brand-green font-bold uppercase">{measureUnit}</button>
                                        <div className="ml-auto text-xl font-bold">{Math.round(selectedFood.calories * (selectedFood.userGrams/100))} <span className="text-xs font-normal">kcal</span></div>
                                    </div>
                                    <button onClick={addToLog} className="w-full py-3 bg-brand-green text-brand-navy font-bold rounded-xl hover:bg-white">Add to Log</button>
                                </div>
                            )}

                            {/* DATA TABLE LOG */}
                            <div className="bg-brand-card rounded-2xl border border-slate-700 overflow-hidden">
                                <div className="p-4 border-b border-slate-700 flex justify-between items-center bg-slate-800/50">
                                    <h3 className="font-bold text-sm uppercase">Daily Entries</h3>
                                    <button onClick={exportFullHistory} className="text-xs text-brand-teal hover:underline">Export Full History</button>
                                </div>
                                <div className="overflow-x-auto table-scroll">
                                    <table className="w-full text-xs text-left text-slate-300">
                                        <thead className="text-xs text-slate-400 uppercase bg-slate-800">
                                            <tr>
                                                <th className="px-4 py-3">Time</th>
                                                <th className="px-4 py-3">Food</th>
                                                <th className="px-4 py-3">Grams</th>
                                                <th className="px-4 py-3 text-brand-green">Cals</th>
                                                <th className="px-4 py-3">Pro</th>
                                                <th className="px-4 py-3">Carb</th>
                                                <th className="px-4 py-3">Fat</th>
                                                <th className="px-4 py-3">Fib</th>
                                                <th className="px-4 py-3">立3</th>
                                                <th className="px-4 py-3">立6</th>
                                                <th className="px-4 py-3"></th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {log.map(item => (
                                                <tr key={item.id} className="border-b border-slate-700 hover:bg-slate-700/30">
                                                    <td className="px-4 py-3 font-mono text-slate-500">{item.time}</td>
                                                    <td className="px-4 py-3 font-medium text-white max-w-[150px] truncate">{item.name}</td>
                                                    <td className="px-4 py-3">{Math.round(item.grams)}</td>
                                                    <td className="px-4 py-3 font-bold text-white">{item.calories}</td>
                                                    <td className="px-4 py-3 text-brand-teal">{Math.round(item.protein)}</td>
                                                    <td className="px-4 py-3 text-brand-green">{Math.round(item.carbs)}</td>
                                                    <td className="px-4 py-3 text-yellow-400">{Math.round(item.fat)}</td>
                                                    <td className="px-4 py-3 text-purple-400">{Math.round(item.fiber || 0)}</td>
                                                    <td className="px-4 py-3 text-sky-400">{(item.o3 || 0).toFixed(1)}</td>
                                                    <td className="px-4 py-3 text-orange-400">{(item.o6 || 0).toFixed(1)}</td>
                                                    <td className="px-4 py-3 text-right">
                                                        <button onClick={() => deleteItem(item.id)} className="text-red-400 hover:text-red-300">x</button>
                                                    </td>
                                                </tr>
                                            ))}
                                            {/* TOTALS ROW */}
                                            <tr className="bg-slate-800 font-bold text-white">
                                                <td colSpan="3" className="px-4 py-3 text-right uppercase text-slate-400">Totals</td>
                                                <td className="px-4 py-3">{Math.round(totals.cals)}</td>
                                                <td className="px-4 py-3">{Math.round(totals.pro)}</td>
                                                <td className="px-4 py-3">{Math.round(totals.carb)}</td>
                                                <td className="px-4 py-3">{Math.round(totals.fat)}</td>
                                                <td className="px-4 py-3">{Math.round(totals.fib)}</td>
                                                <td className="px-4 py-3">{totals.o3.toFixed(1)}</td>
                                                <td className="px-4 py-3">{totals.o6.toFixed(1)}</td>
                                                <td></td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </>
                    ) : (
                        /* TRENDS VIEW */
                        <div className="bg-brand-card p-4 rounded-2xl border border-slate-700">
                            <h3 className="font-bold text-white mb-4">Weekly Trends (Weight vs. Calories)</h3>
                            <div className="relative h-80 w-full">
                                <canvas id="trendChart"></canvas>
                            </div>
                            <div className="mt-4 text-center text-xs text-slate-400">
                                This chart visualizes your average caloric intake vs. recorded weight week over week.
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
