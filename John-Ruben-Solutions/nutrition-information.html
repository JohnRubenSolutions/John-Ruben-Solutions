<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>John Ruben Solutions - Unified Elite Tracker</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut, createUserWithEmailAndPassword, GoogleAuthProvider, signInWithPopup, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, where, onSnapshot, deleteDoc, doc, setDoc, getDoc, orderBy, serverTimestamp, getDocs, limit, writeBatch } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        
        const firebaseConfig = {
            apiKey: "AIzaSyD2h_sejv6lB8sFC15xHSgqxfdD2hLd5Kg",
            authDomain: "john-ruben-solutions.firebaseapp.com",
            projectId: "john-ruben-solutions",
            storageBucket: "john-ruben-solutions.firebasestorage.app",
            messagingSenderId: "761855596159",
            appId: "1:761855596159:web:a4bbe805663c2304c5d14a",
            measurementId: "G-1T2J8VR066"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const googleProvider = new GoogleAuthProvider();
        
        window.fb = { auth, db, googleProvider, signInWithPopup, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut, sendPasswordResetEmail, collection, addDoc, query, where, onSnapshot, deleteDoc, doc, setDoc, getDoc, getDocs, orderBy, serverTimestamp, limit, writeBatch };
    </script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        brand: { navy: '#0f172a', dark: '#020617', card: '#1e293b', green: '#84cc16', teal: '#22d3ee', input: '#334155' }
                    },
                    fontFamily: { sans: ['"Plus Jakarta Sans"', 'sans-serif'] }
                }
            }
        }
    </script>
    <style> 
        body { background-color: #0f172a; color: #f8fafc; } 
        #reader { width: 100% !important; border: none !important; }
        #reader video { object-fit: cover; border-radius: 12px; }
        .table-scroll::-webkit-scrollbar { height: 4px; width: 4px; }
        .table-scroll::-webkit-scrollbar-thumb { background: #84cc16; border-radius: 4px; }
        .table-scroll::-webkit-scrollbar-track { background: #1e293b; }
        .animate-fade { animation: fadeIn 0.3s ease-in; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;
        const API_KEY = '4FRpc4urF9W2UedPH6agara8y52PR0efkZRmoPvv'; 

        const WORKOUT_LIBRARY = {
            "Chest": ["Bench Press", "Incline DB Press", "Cable Flyes", "Pushups", "Dips"],
            "Back": ["Pull Ups", "Lat Pulldowns", "Bent Over Rows", "Deadlifts", "Face Pulls", "Stability Ball Hyperextension"],
            "Shoulders": ["Overhead Press", "Dumbbell Front Raise", "Dumbbell Lateral Raise", "Rear Delt Flyes"],
            "Arms": ["Dumbbell Bicep Curl", "Hammer Curls", "Cable Tricep Pushdown", "Skull Crushers"],
            "Legs": ["Squats", "Leg Press", "Leg Extensions", "Hamstring Curls", "Calf Raises", "Hip Bridge Thrusts", "Side Leg Raises", "Standing Hip Adduction", "Air Squats"],
            "Core": ["Exercise Ball Crunch", "Plank", "Leg Raises", "Russian Twists"],
            "Cardio/Other": ["Running", "Jog in place", "Cycling", "Swimming"]
        };

        const AuthScreen = () => {
            const [isRegister, setIsRegister] = useState(false);
            const [isReset, setIsReset] = useState(false);
            const [email, setEmail] = useState("");
            const [password, setPassword] = useState("");
            const [error, setError] = useState("");

            const handleGoogleLogin = async () => {
                try { await window.fb.signInWithPopup(window.fb.auth, window.fb.googleProvider); } 
                catch (err) { setError(err.message); }
            };

            const handleSubmit = async (e) => {
                e.preventDefault();
                setError("");
                try {
                    if (isReset) {
                        await window.fb.sendPasswordResetEmail(window.fb.auth, email);
                        alert("Reset link sent!");
                        setIsReset(false);
                    } else if (isRegister) {
                        await window.fb.createUserWithEmailAndPassword(window.fb.auth, email, password);
                    } else {
                        await window.fb.signInWithEmailAndPassword(window.fb.auth, email, password);
                    }
                } catch (err) { setError(err.message); }
            };

            return (
                <div className="min-h-screen flex items-center justify-center p-4 text-center">
                    <div className="bg-brand-card p-8 rounded-3xl w-full max-w-sm border border-slate-700 shadow-2xl animate-fade">
                        <h2 className="text-xl font-bold text-white mb-6">Elite Tracker</h2>
                        <button onClick={handleGoogleLogin} className="w-full py-3 bg-white text-slate-900 font-bold rounded-xl mb-4 transition-all">Continue with Google</button>
                        <form onSubmit={handleSubmit}>
                            <input type="email" placeholder="Email" className="w-full p-3 mb-4 bg-brand-input rounded-xl text-white outline-none" value={email} onChange={e=>setEmail(e.target.value)} required />
                            {!isReset && <input type="password" placeholder="Password" className="w-full p-3 mb-6 bg-brand-input rounded-xl text-white outline-none" value={password} onChange={e=>setPassword(e.target.value)} required />}
                            {error && <p className="text-red-500 text-xs mb-4">{error}</p>}
                            <button type="submit" className="w-full py-3 bg-brand-navy border border-brand-green text-brand-green font-bold rounded-xl">{isReset ? "Send Link" : (isRegister ? "Sign Up" : "Log In")}</button>
                        </form>
                        <button onClick={()=>setIsRegister(!isRegister)} className="mt-4 text-xs text-slate-400 underline">{isRegister ? "Back to Login" : "Need account? Sign Up"}</button>
                    </div>
                </div>
            );
        };

        const App = () => {
            const [user, setUser] = useState(null);
            const [appMode, setAppMode] = useState("nutrition");
            const [view, setView] = useState("daily");
            const [profile, setProfile] = useState(null);
            const [currentDate, setCurrentDate] = useState(new Date().toISOString().split('T')[0]);
            const [targets, setTargets] = useState({ calories: 2000, protein: 150, carbs: 200, fat: 60 });
            const [query, setQuery] = useState("");
            const [results, setResults] = useState([]);
            const [nutritionLog, setNutritionLog] = useState([]);
            const [dailyWeight, setDailyWeight] = useState("");
            const [selectedFood, setSelectedFood] = useState(null);
            const [displayAmount, setDisplayAmount] = useState(100);
            const [measureUnit, setMeasureUnit] = useState('g');
            const [isScanning, setIsScanning] = useState(false);
            const [loading, setLoading] = useState(false);
            const [activeRoutine, setActiveRoutine] = useState([]);
            const scannerRef = useRef(null);

            useEffect(() => {
                const unsub = window.fb.onAuthStateChanged(window.fb.auth, u => { setUser(u); if(u) loadProfile(u.uid); });
                return () => unsub();
            }, []);

            const loadProfile = async (uid) => {
                const snap = await window.fb.getDoc(window.fb.doc(window.fb.db, "users", uid, "data", "profile"));
                if (snap.exists()) setProfile(snap.data());
            };

            // MACRO CALCULATOR WITH CLINICAL PROTEIN FLOOR
            useEffect(() => {
                if (profile && dailyWeight) {
                    const weightLbs = parseFloat(dailyWeight);
                    if (!weightLbs || weightLbs < 50) return;
                    const kg = weightLbs * 0.453592;
                    const hCm = (parseFloat(profile.height) || 67) * 2.54;
                    const bmr = (10 * kg) + (6.25 * hCm) - (5 * (parseFloat(profile.age) || 35)) + (profile.gender === 'female' ? -161 : 5);
                    const targetCal = Math.round(bmr * (parseFloat(profile.activity) || 1.55)) + (parseFloat(profile.goal) || -500);
                    const minP = Math.round(1.6 * kg);
                    let pr=0.4, cr=0.3, fr=0.3;
                    if(profile.bodyType==='ecto'){ pr=0.3; cr=0.5; fr=0.2; } else if(profile.bodyType==='endo'){ pr=0.4; cr=0.2; fr=0.4; }
                    let pG = Math.round((targetCal * pr)/4), cG = Math.round((targetCal * cr)/4), fG = Math.round((targetCal * fr)/9);
                    if(pG < minP) { pG = minP; cG = Math.round((targetCal * cr)/4); fG = Math.max(0, Math.round((targetCal - (pG*4) - (cG*4))/9)); }
                    setTargets({ calories: targetCal, protein: pG, carbs: cG, fat: fG });
                }
            }, [dailyWeight, profile]);

            useEffect(() => {
                if (!user) return;
                const nQ = window.fb.query(window.fb.collection(window.fb.db, "users", user.uid, "logs"), window.fb.where("date", "==", currentDate));
                const unsubN = window.fb.onSnapshot(nQ, snap => setNutritionLog(snap.docs.map(d => ({id: d.id, ...d.data()}))));
                const fetchW = async () => {
                    const snap = await window.fb.getDoc(window.fb.doc(window.fb.db, "users", user.uid, "daily_stats", currentDate));
                    setDailyWeight(snap.exists() ? snap.data().weight : "");
                };
                fetchW();
                return () => unsubN();
            }, [user, currentDate]);

            const handleSearch = async (e) => {
                if(e) e.preventDefault(); if(!query) return; setLoading(true);
                try {
                    const res = await fetch(`https://api.nal.usda.gov/fdc/v1/foods/search?api_key=${API_KEY}&query=${query}&pageSize=10`);
                    const data = await res.json();
                    if(data.foods) setResults(data.foods.map(f => ({...f, description: f.description, fdcId: f.fdcId})));
                } catch(e){} setLoading(false);
            };

            const selectFood = async (f) => {
                setLoading(true);
                const res = await fetch(`https://api.nal.usda.gov/fdc/v1/food/${f.fdcId}?api_key=${API_KEY}`);
                const d = await res.json();
                const g = (ids) => { const n = (d.foodNutrients||[]).find(x => ids.includes(x.nutrientId||x.nutrient?.id)); return n ? (n.amount||n.value||0) : 0; };
                setSelectedFood({ name: d.description, calories: g([1008, 208]), protein: g([1003, 203]), carbs: g([1005, 205]), fat: g([1004, 204]), fiber: g([1079]), userGrams: 100 });
                setResults([]); setLoading(false);
            };

            const addToLog = async () => {
                const g = measureUnit==='oz' ? displayAmount*28.3495 : displayAmount;
                const f = g/100;
                await window.fb.addDoc(window.fb.collection(window.fb.db, "users", user.uid, "logs"), {
                    name: selectedFood.name, calories: selectedFood.calories*f, protein: selectedFood.protein*f, carbs: selectedFood.carbs*f, fat: selectedFood.fat*f, fiber: (selectedFood.fiber||0)*f, date: currentDate, createdAt: window.fb.serverTimestamp()
                });
                setSelectedFood(null); setQuery("");
            };

            const exportMasterReport = async () => {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                const snap = await window.fb.getDocs(window.fb.collection(window.fb.db, "users", user.uid, "logs"));
                const logs = snap.docs.map(d => d.data());
                
                const dataByDate = {};
                logs.forEach(l => {
                    if(!dataByDate[l.date]) dataByDate[l.date] = { c:0, p:0, cr:0, f:0, fb:0, items:[] };
                    dataByDate[l.date].c += l.calories; dataByDate[l.date].p += l.protein; dataByDate[l.date].cr += l.carbs; dataByDate[l.date].f += l.fat; dataByDate[l.date].fb += (l.fiber||0);
                    dataByDate[l.date].items.push(l);
                });

                const sortedDates = Object.keys(dataByDate).sort().reverse();
                doc.setFontSize(16); doc.text("ELITE PERFORMANCE HISTORY", 14, 20);
                let y = 30;

                sortedDates.forEach(d => {
                    if(y > 250) { doc.addPage(); y = 20; }
                    doc.setFontSize(10); doc.text(`DATE: ${d}`, 14, y);
                    const rows = dataByDate[d].items.map(i => [i.name, Math.round(i.calories), i.protein.toFixed(1)+'g', i.carbs.toFixed(1)+'g', i.fat.toFixed(1)+'g']);
                    rows.push([{content:'TOTAL', styles:{fontStyle:'bold', fillColor:[230,230,230]}}, Math.round(dataByDate[d].c), dataByDate[d].p.toFixed(1)+'g', dataByDate[d].cr.toFixed(1)+'g', dataByDate[d].f.toFixed(1)+'g']);
                    doc.autoTable({ startY: y+2, head: [['Food', 'Cals', 'P', 'C', 'F']], body: rows, theme: 'grid', styles: {fontSize: 7} });
                    y = doc.lastAutoTable.finalY + 10;
                });

                // CALENDAR WEEK AVERAGES LOGIC
                doc.addPage();
                doc.setFontSize(14); doc.text("WEEKLY PERFORMANCE AVERAGES", 14, 20);
                
                const anchor = new Date("2025-12-28T00:00:00");
                const today = new Date();
                const weekBuckets = [];
                
                let currentStart = new Date(anchor);
                while(currentStart <= today) {
                    let currentEnd = new Date(currentStart);
                    currentEnd.setDate(currentEnd.getDate() + 6);
                    
                    const weekDates = [];
                    for(let i=0; i<7; i++) {
                        let dd = new Date(currentStart); dd.setDate(dd.getDate() + i);
                        weekDates.push(dd.toISOString().split('T')[0]);
                    }

                    const activeDays = weekDates.filter(d => dataByDate[d]);
                    if(activeDays.length > 0) {
                        const sum = activeDays.reduce((acc, d) => ({
                            c: acc.c + dataByDate[d].c, p: acc.p + dataByDate[d].p, cr: acc.cr + dataByDate[d].cr, f: acc.f + dataByDate[d].f
                        }), {c:0, p:0, cr:0, f:0});
                        
                        const count = activeDays.length;
                        weekBuckets.push([
                            `Week ${weekBuckets.length + 1} (${currentStart.toLocaleDateString()} - ${currentEnd.toLocaleDateString()})`,
                            Math.round(sum.c/count), (sum.p/count).toFixed(1)+'g', (sum.cr/count).toFixed(1)+'g', (sum.f/count).toFixed(1)+'g'
                        ]);
                    } else {
                        // Week exists in calendar but no data
                        weekBuckets.push([`Week ${weekBuckets.length + 1} (${currentStart.toLocaleDateString()})`, "No Data", "-", "-", "-"]);
                    }
                    currentStart.setDate(currentStart.getDate() + 7);
                }

                doc.autoTable({ startY: 30, head: [['Week Period', 'Avg Cals', 'Avg P', 'Avg C', 'Avg F']], body: weekBuckets.reverse(), theme: 'striped' });
                doc.save(`Elite_Report_${currentDate}.pdf`);
            };

            const totals = nutritionLog.reduce((acc, i) => ({ c: acc.c + i.calories, p: acc.p + i.protein, cr: acc.cr + i.carbs, f: acc.f + i.fat }), { c:0, p:0, cr:0, f:0 });

            if (!user) return <AuthScreen />;
            const ratio = selectedFood ? ((measureUnit==='oz'?displayAmount*28.3495:displayAmount)/100) : 0;

            return (
                <div className="max-w-4xl mx-auto px-4 pt-6 pb-24 font-sans text-white">
                    <div className="flex bg-brand-card rounded-2xl p-1 mb-6 border border-slate-700">
                        <button onClick={() => setAppMode("nutrition")} className={`flex-1 py-3 rounded-xl font-bold text-sm ${appMode==='nutrition'?'bg-brand-green text-brand-navy':'text-slate-400'}`}>Nutrition</button>
                        <button onClick={() => setAppMode("workout")} className={`flex-1 py-3 rounded-xl font-bold text-sm ${appMode==='workout'?'bg-brand-teal text-brand-navy':'text-slate-400'}`}>Elite Workout</button>
                    </div>

                    <div className="flex justify-between items-center mb-6 bg-brand-card p-4 rounded-2xl border border-slate-700">
                        <div className="flex items-center gap-4">
                            <button onClick={()=>changeDate(-1)} className="font-bold">&lt;</button>
                            <span className="font-bold text-sm">{currentDate}</span>
                            <button onClick={()=>changeDate(1)} className="font-bold">&gt;</button>
                        </div>
                        <div className="flex items-center gap-2 bg-brand-input px-3 py-1 rounded-xl">
                            <span className="text-[10px] text-slate-400 uppercase font-bold">Weight</span>
                            <input type="number" value={dailyWeight} onChange={e=>setDailyWeight(e.target.value)} onBlur={()=>window.fb.setDoc(window.fb.doc(window.fb.db,"users",user.uid,"daily_stats",currentDate),{weight:dailyWeight,date:currentDate},{merge:true})} className="w-12 bg-transparent text-right font-bold outline-none" />
                            <span className="text-[10px] text-brand-green font-bold">LBS</span>
                        </div>
                    </div>

                    {appMode === 'nutrition' ? (
                        <div className="animate-fade">
                            <div className="grid grid-cols-2 md:grid-cols-4 gap-2 mb-6">
                                <div className="bg-brand-card p-3 rounded-xl border border-slate-700 text-center"><span className="text-[10px] text-slate-400 block">Cals</span><span className="font-bold">{Math.round(totals.c)} / {targets.calories}</span></div>
                                <div className="bg-brand-card p-3 rounded-xl border border-slate-700 text-center"><span className="text-[10px] text-brand-teal block uppercase">P</span><span className="font-bold">{Math.round(totals.p)}g</span></div>
                                <div className="bg-brand-card p-3 rounded-xl border border-slate-700 text-center"><span className="text-[10px] text-brand-green block uppercase">C</span><span className="font-bold">{Math.round(totals.cr)}g</span></div>
                                <div className="bg-brand-card p-3 rounded-xl border border-slate-700 text-center"><span className="text-[10px] text-yellow-500 block uppercase">F</span><span className="font-bold">{Math.round(totals.f)}g</span></div>
                            </div>

                            <form onSubmit={handleSearch} className="mb-6 relative">
                                <input type="text" value={query} onChange={e=>setQuery(e.target.value)} placeholder="Search food..." className="w-full p-4 bg-brand-input rounded-2xl outline-none" />
                                <button type="submit" className="absolute right-4 top-4 text-brand-green font-bold">FIND</button>
                            </form>

                            {results.length > 0 && (
                                <div className="bg-brand-card rounded-2xl border border-slate-700 mb-6 max-h-48 overflow-y-auto">
                                    {results.map(f => <div key={f.fdcId} onClick={()=>selectFood(f)} className="p-4 border-b border-slate-700 cursor-pointer hover:bg-slate-700">{f.description}</div>)}
                                </div>
                            )}

                            {selectedFood && (
                                <div className="bg-brand-card p-6 rounded-3xl border border-brand-green mb-6 animate-fade">
                                    <h4 className="font-bold mb-4">{selectedFood.name}</h4>
                                    <div className="flex items-center justify-between bg-brand-input p-4 rounded-2xl mb-4">
                                        <div className="flex items-center gap-2">
                                            <input type="number" value={displayAmount} onChange={e=>setDisplayAmount(e.target.value)} className="w-20 bg-transparent text-2xl font-bold outline-none" />
                                            <button onClick={()=>setMeasureUnit(measureUnit==='g'?'oz':'g')} className="text-xs font-bold text-brand-green uppercase">{measureUnit}</button>
                                        </div>
                                        <div className="text-right"><span className="text-2xl font-bold block">{Math.round(selectedFood.calories * ratio)}</span><span className="text-[10px] text-slate-500">CALS</span></div>
                                    </div>
                                    <button onClick={addToLog} className="w-full py-4 bg-brand-green text-brand-navy font-bold rounded-2xl">ADD TO LOG</button>
                                </div>
                            )}

                            <div className="bg-brand-card rounded-2xl border border-slate-700 overflow-hidden shadow-xl table-scroll overflow-x-auto">
                                <table className="w-full text-xs text-left text-slate-300 min-w-[500px]">
                                    <thead className="bg-slate-800 text-slate-400">
                                        <tr><th className="px-4 py-3">Food</th><th className="px-4 py-3 text-center">Cals</th><th className="px-4 py-3 text-center">P</th><th className="px-4 py-3 text-center">C</th><th className="px-4 py-3 text-center">F</th><th className="px-4 py-3"></th></tr>
                                    </thead>
                                    <tbody>
                                        {nutritionLog.map(i => (
                                            <tr key={i.id} className="border-b border-slate-700 hover:bg-slate-700/20">
                                                <td className="px-4 py-3 font-medium text-white">{i.name}</td>
                                                <td className="px-4 py-3 text-center">{Math.round(i.calories)}</td>
                                                <td className="px-4 py-3 text-center text-brand-teal">{i.protein.toFixed(1)}g</td>
                                                <td className="px-4 py-3 text-center text-brand-green">{i.carbs.toFixed(1)}g</td>
                                                <td className="px-4 py-3 text-center text-yellow-500">{i.fat.toFixed(1)}g</td>
                                                <td className="px-4 py-3 text-right"><button onClick={()=>window.fb.deleteDoc(window.fb.doc(window.fb.db,"users",user.uid,"logs",i.id))} className="text-red-400 font-bold p-1">âœ•</button></td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    ) : (
                        <div className="animate-fade text-center py-20 bg-brand-card rounded-3xl border border-slate-700">
                            <p className="text-slate-500 font-bold">Workout Tracking Module Active</p>
                        </div>
                    )}

                    <div className="fixed bottom-0 left-0 right-0 p-4 bg-brand-navy/90 backdrop-blur-md flex gap-2 border-t border-slate-800">
                        <button onClick={exportMasterReport} className="flex-1 bg-brand-green text-brand-navy font-bold py-4 rounded-2xl uppercase tracking-tighter">Download Master Report (PDF)</button>
                        <button onClick={() => window.fb.signOut(window.fb.auth)} className="bg-slate-800 px-6 rounded-2xl text-red-400 font-bold">Exit</button>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
