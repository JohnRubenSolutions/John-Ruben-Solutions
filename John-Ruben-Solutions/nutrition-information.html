<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>John Ruben Solutions - Unified Elite Tracker</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut, createUserWithEmailAndPassword, GoogleAuthProvider, signInWithPopup } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, where, onSnapshot, deleteDoc, doc, setDoc, getDoc, orderBy, serverTimestamp, getDocs, limit, writeBatch } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        
        const firebaseConfig = {
            apiKey: "AIzaSyD2h_sejv6lB8sFC15xHSgqxfdD2hLd5Kg",
            authDomain: "john-ruben-solutions.firebaseapp.com",
            projectId: "john-ruben-solutions",
            storageBucket: "john-ruben-solutions.firebasestorage.app",
            messagingSenderId: "761855596159",
            appId: "1:761855596159:web:a4bbe805663c2304c5d14a",
            measurementId: "G-1T2J8VR066"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const googleProvider = new GoogleAuthProvider();
        
        window.fb = { auth, db, googleProvider, signInWithPopup, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut, collection, addDoc, query, where, onSnapshot, deleteDoc, doc, setDoc, getDoc, getDocs, orderBy, serverTimestamp, limit, writeBatch };
    </script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        brand: { navy: '#0f172a', dark: '#020617', card: '#1e293b', green: '#84cc16', teal: '#22d3ee', input: '#334155' }
                    },
                    fontFamily: { sans: ['"Plus Jakarta Sans"', 'sans-serif'] }
                }
            }
        }
    </script>
    <style> 
        body { background-color: #0f172a; color: #f8fafc; } 
        #reader video { object-fit: cover; border-radius: 12px; }
        .table-scroll::-webkit-scrollbar { height: 4px; width: 4px; }
        .table-scroll::-webkit-scrollbar-thumb { background: #84cc16; border-radius: 4px; }
        .table-scroll::-webkit-scrollbar-track { background: #1e293b; }
        .active-timer { animation: pulse 2s infinite; color: #84cc16; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.6; } }
        .animate-fade { animation: fadeIn 0.3s ease-in; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;
        const API_KEY = '4FRpc4urF9W2UedPH6agara8y52PR0efkZRmoPvv'; 

        const WORKOUT_LIBRARY = {
            "Chest": ["Bench Press", "Incline DB Press", "Cable Flyes", "Pushups", "Dips"],
            "Back": ["Pull Ups", "Lat Pulldowns", "Bent Over Rows", "Deadlifts", "Face Pulls", "Stability Ball Hyperextension"],
            "Shoulders": ["Overhead Press", "Dumbbell Front Raise", "Dumbbell Lateral Raise", "Rear Delt Flyes"],
            "Arms": ["Dumbbell Bicep Curl", "Hammer Curls", "Cable Tricep Pushdown", "Skull Crushers"],
            "Legs": ["Squats", "Leg Press", "Leg Extensions", "Hamstring Curls", "Calf Raises", "Hip Bridge Thrusts", "Side Leg Raises", "Standing Hip Adduction", "Air Squats"],
            "Core": ["Exercise Ball Crunch", "Plank", "Leg Raises", "Russian Twists"],
            "Cardio/Other": ["Running", "Jog in place", "Cycling", "Swimming"]
        };

        const getWeekNumber = (d) => {
            d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
            d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay() || 7));
            const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
            return `${d.getUTCFullYear()}-W${Math.ceil((((d - yearStart) / 86400000) + 1) / 7)}`;
        };

        const formatWeekLabel = (weekStr) => {
             const parts = weekStr.split('-');
             return `Week ${parts[1].replace('W','')}, ${parts[0]}`;
        };

        const AuthScreen = () => {
            const [isRegister, setIsRegister] = useState(false);
            const [email, setEmail] = useState("");
            const [password, setPassword] = useState("");
            const [error, setError] = useState("");
            const handleGoogleLogin = async () => {
                try { await window.fb.signInWithPopup(window.fb.auth, window.fb.googleProvider); } 
                catch (err) { setError(err.message); }
            };
            const handleSubmit = async (e) => {
                e.preventDefault();
                try {
                    if (isRegister) await window.fb.createUserWithEmailAndPassword(window.fb.auth, email, password);
                    else await window.fb.signInWithEmailAndPassword(window.fb.auth, email, password);
                } catch (err) { setError(err.message); }
            };
            return (
                <div className="min-h-screen flex items-center justify-center p-4">
                    <div className="bg-brand-card p-8 rounded-3xl w-full max-w-sm border border-slate-700">
                        <h2 className="text-xl font-bold text-white mb-6 text-center">{isRegister ? "Join Elite Tracker" : "Elite Login"}</h2>
                        <button onClick={handleGoogleLogin} className="w-full py-3 bg-white text-slate-900 font-bold rounded-xl mb-4 flex items-center justify-center gap-2">Continue with Google</button>
                        <form onSubmit={handleSubmit}>
                            <input type="email" placeholder="Email" className="w-full p-3 mb-4 bg-brand-input rounded-xl text-white outline-none" value={email} onChange={e=>setEmail(e.target.value)} />
                            <input type="password" placeholder="Password" className="w-full p-3 mb-6 bg-brand-input rounded-xl text-white outline-none" value={password} onChange={e=>setPassword(e.target.value)} />
                            {error && <p className="text-red-500 text-xs mb-4 text-center">{error}</p>}
                            <button type="submit" className="w-full py-3 bg-brand-navy border border-brand-green text-brand-green font-bold rounded-xl">{isRegister ? "Sign Up" : "Log In"}</button>
                        </form>
                        <button onClick={()=>setIsRegister(!isRegister)} className="w-full mt-4 text-xs text-slate-400 underline">{isRegister ? "Already have an account? Log In" : "Need account? Sign Up"}</button>
                    </div>
                </div>
            );
        };

        const Timer = ({ seconds, label }) => {
            const [timeLeft, setTimeLeft] = useState(seconds);
            const [isActive, setIsActive] = useState(false);
            useEffect(() => {
                let iter = null;
                if (isActive && timeLeft > 0) iter = setInterval(() => setTimeLeft(t => t - 1), 1000);
                else clearInterval(iter);
                return () => clearInterval(iter);
            }, [isActive, timeLeft]);
            const fmt = (s) => `${Math.floor(s / 60)}:${String(s % 60).padStart(2, '0')}`;
            return (
                <div className="flex items-center justify-between bg-slate-800/50 p-3 rounded-xl border border-slate-700 mb-2">
                    <span className="text-xs text-slate-400 font-bold">{label}</span>
                    <div className="flex items-center gap-4">
                        <span className={`font-mono text-xl ${isActive ? 'active-timer' : 'text-slate-500'}`}>{fmt(timeLeft)}</span>
                        <button onClick={() => setIsActive(!isActive)} className={`px-3 py-1 rounded-lg text-[10px] font-bold uppercase ${isActive ? 'bg-red-500/20 text-red-400' : 'bg-brand-green text-brand-navy'}`}>{isActive ? 'Stop' : 'Start'}</button>
                    </div>
                </div>
            );
        };

        const App = () => {
            const [user, setUser] = useState(null);
            const [appMode, setAppMode] = useState("nutrition");
            const [view, setView] = useState("daily");
            const [profile, setProfile] = useState(null);
            const [currentDate, setCurrentDate] = useState(new Date().toISOString().split('T')[0]);
            
            // Nutrition State
            const [targets, setTargets] = useState({ calories: 2000, protein: 150, carbs: 200, fat: 60 });
            const [query, setQuery] = useState("");
            const [results, setResults] = useState([]);
            const [nutritionLog, setNutritionLog] = useState([]);
            const [dailyWeight, setDailyWeight] = useState("");
            const [showManual, setShowManual] = useState(false);
            const [manualForm, setManualForm] = useState({ name: "", p: "", c: "", f: "", fib: "" });
            const [selectedFood, setSelectedFood] = useState(null);
            const [isScanning, setIsScanning] = useState(false);
            const [loading, setLoading] = useState(false);
            const [scores, setScores] = useState({ adherence: 0, consistency: 0 });

            // Workout State
            const [workoutLogs, setWorkoutLogs] = useState([]);
            const [workoutHistory, setWorkoutHistory] = useState({});
            const [customSets, setCustomSets] = useState({});
            const [showLibrary, setShowLibrary] = useState(false);
            const [activeRoutine, setActiveRoutine] = useState([]);

            const scannerRef = useRef(null);
            const chartRef = useRef(null);
            const chartInstance = useRef(null);

            useEffect(() => {
                const unsubscribe = window.fb.onAuthStateChanged(window.fb.auth, (u) => {
                    setUser(u);
                    if(u) loadProfile(u.uid);
                });
                return () => unsubscribe();
            }, []);

            const loadProfile = async (uid) => {
                const docRef = window.fb.doc(window.fb.db, "users", uid, "data", "profile");
                const snap = await window.fb.getDoc(docRef);
                if (snap.exists()) setProfile(snap.data());
                const targetRef = window.fb.doc(window.fb.db, "users", uid, "data", "targets");
                const targetSnap = await window.fb.getDoc(targetRef);
                if (targetSnap.exists()) setTargets(targetSnap.data());
            };

            useEffect(() => {
                if (!user || !window.fb) return;
                
                const nQ = window.fb.query(window.fb.collection(window.fb.db, "users", user.uid, "logs"), window.fb.where("date", "==", currentDate));
                const unsubN = window.fb.onSnapshot(nQ, (snap) => {
                    const raw = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                    raw.sort((a,b) => (a.createdAt?.seconds || 0) - (b.createdAt?.seconds || 0));
                    setNutritionLog(raw);
                });

                const wQ = window.fb.query(window.fb.collection(window.fb.db, "users", user.uid, "workout_logs"), window.fb.where("date", "==", currentDate));
                const unsubW = window.fb.onSnapshot(wQ, (snap) => {
                    setWorkoutLogs(snap.docs.map(d => ({id: d.id, ...d.data()})));
                });

                const rQ = window.fb.doc(window.fb.db, "users", user.uid, "active_routines", currentDate);
                const unsubR = window.fb.onSnapshot(rQ, (doc) => {
                    if(doc.exists()) setActiveRoutine(doc.data().exercises || []);
                    else setActiveRoutine([]);
                });

                const fetchWeight = async () => {
                    const docSnap = await window.fb.getDoc(window.fb.doc(window.fb.db, "users", user.uid, "daily_stats", currentDate));
                    setDailyWeight(docSnap.exists() ? docSnap.data().weight : "");
                };

                fetchWeight();
                return () => { unsubN(); unsubW(); unsubR(); };
            }, [user, currentDate]);

            useEffect(() => {
                if(!user || activeRoutine.length === 0) return;
                activeRoutine.forEach(async (ex) => {
                    const hQ = window.fb.query(window.fb.collection(window.fb.db, user.uid, "workout_logs"), window.fb.where("exercise", "==", ex.name), window.fb.orderBy("timestamp", "desc"), window.fb.limit(1));
                    const hSnap = await window.fb.getDocs(hQ);
                    if(!hSnap.empty) setWorkoutHistory(prev => ({...prev, [ex.name]: hSnap.docs[0].data()}));
                });
            }, [activeRoutine, user]);

            useEffect(() => {
                if (view === 'trends' && user && appMode === 'nutrition') {
                    setTimeout(calculateAnalytics, 200); 
                }
            }, [view, user, appMode]);

            const calculateAnalytics = async () => {
                if(!chartRef.current || !user) return;
                const logSnap = await window.fb.getDocs(window.fb.collection(window.fb.db, "users", user.uid, "logs"));
                const weightSnap = await window.fb.getDocs(window.fb.collection(window.fb.db, "users", user.uid, "daily_stats"));
                const dailyData = {}; 
                logSnap.forEach(doc => {
                    const d = doc.data();
                    if(!dailyData[d.date]) dailyData[d.date] = { cals: 0, weight: null };
                    dailyData[d.date].cals += d.calories;
                });
                weightSnap.forEach(doc => {
                    const d = doc.data();
                    if(!dailyData[d.date]) dailyData[d.date] = { cals: 0, weight: null };
                    dailyData[d.date].weight = parseFloat(d.weight);
                });
                const dates = Object.keys(dailyData).sort();
                if (dates.length > 0) {
                    const totalDays = Math.ceil(Math.abs(new Date(dates[dates.length-1]) - new Date(dates[0])) / 86400000) + 1;
                    const consistencyScore = Math.round((dates.length / totalDays) * 100);
                    let adherenceDays = 0;
                    const target = targets.calories || 2000;
                    dates.forEach(d => {
                        const intake = dailyData[d].cals;
                        if (intake > 0 && Math.abs(intake - target) <= (target * 0.10)) adherenceDays++;
                    });
                    setScores({ adherence: Math.round((adherenceDays / dates.length) * 100), consistency: consistencyScore });
                }
                const weeklyData = {};
                Object.keys(dailyData).forEach(dateStr => {
                    const weekKey = getWeekNumber(new Date(dateStr));
                    if(!weeklyData[weekKey]) weeklyData[weekKey] = { totalCals: 0, daysWithCals: 0, totalWeight: 0, daysWithWeight: 0 };
                    if(dailyData[dateStr].cals > 0) { weeklyData[weekKey].totalCals += dailyData[dateStr].cals; weeklyData[weekKey].daysWithCals++; }
                    if(dailyData[dateStr].weight > 0) { weeklyData[weekKey].totalWeight += dailyData[dateStr].weight; weeklyData[weekKey].daysWithWeight++; }
                });
                const sortedWeeks = Object.keys(weeklyData).sort(); 
                const labels = sortedWeeks.map(formatWeekLabel);
                const avgCals = sortedWeeks.map(w => weeklyData[w].daysWithCals ? weeklyData[w].totalCals / weeklyData[w].daysWithCals : null);
                const avgWeights = sortedWeeks.map(w => weeklyData[w].daysWithWeight ? weeklyData[w].totalWeight / weeklyData[w].daysWithWeight : null);
                if (chartInstance.current) chartInstance.current.destroy();
                const ctx = chartRef.current.getContext('2d');
                chartInstance.current = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [
                            { label: 'Avg Calories', data: avgCals, borderColor: '#84cc16', yAxisID: 'y', tension: 0.3, spanGaps: true },
                            { label: 'Avg Weight (lbs)', data: avgWeights, borderColor: '#22d3ee', yAxisID: 'y1', tension: 0.3, spanGaps: true }
                        ]
                    },
                    options: { responsive: true, maintainAspectRatio: false, scales: { y: { type: 'linear', position: 'left' }, y1: { type: 'linear', position: 'right', grid: { drawOnChartArea: false } } } }
                });
            };

            const exportMasterReport = async () => {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                // Fetch all history
                const logsSnap = await window.fb.getDocs(window.fb.collection(window.fb.db, "users", user.uid, "logs"));
                const workoutSnap = await window.fb.getDocs(window.fb.collection(window.fb.db, "users", user.uid, "workout_logs"));
                
                const allNutrition = logsSnap.docs.map(d => d.data());
                const allWorkouts = workoutSnap.docs.map(d => d.data());
                
                // Group by date
                const historyByDate = {};
                allNutrition.forEach(n => {
                    if(!historyByDate[n.date]) historyByDate[n.date] = { nutrition: [], volume: 0 };
                    historyByDate[n.date].nutrition.push(n);
                });
                allWorkouts.forEach(w => {
                    if(!historyByDate[w.date]) historyByDate[w.date] = { nutrition: [], volume: 0 };
                    historyByDate[w.date].volume += (Number(w.volume) || 0);
                });

                const sortedDates = Object.keys(historyByDate).sort().reverse();

                // Section A: Daily Log
                doc.setFontSize(22); doc.setTextColor(15, 23, 42); doc.text("ELITE MASTER REPORT", 14, 20);
                doc.setFontSize(14); doc.text("Historical Daily Logs", 14, 30);
                
                let yPos = 40;
                sortedDates.forEach(date => {
                    if(yPos > 250) { doc.addPage(); yPos = 20; }
                    const day = historyByDate[date];
                    const dailyTotal = day.nutrition.reduce((acc, curr) => ({
                        c: acc.c + curr.calories, p: acc.p + curr.protein, ch: acc.ch + curr.carbs, f: acc.f + curr.fat, fib: acc.fib + (curr.fiber||0)
                    }), { c:0, p:0, ch:0, f:0, fib:0 });

                    doc.setFontSize(10); doc.setTextColor(100); doc.text(`DATE: ${date} | LIFTED VOLUME: ${day.volume.toLocaleString()} lbs`, 14, yPos);
                    
                    const tableRows = day.nutrition.map(n => [n.name, n.calories.toFixed(0), n.protein+'g', n.carbs+'g', n.fat+'g', (n.fiber||0)+'g']);
                    tableRows.push([{content: 'DAILY TOTAL', styles: {fontStyle: 'bold'}}, dailyTotal.c.toFixed(0), dailyTotal.p.toFixed(1)+'g', dailyTotal.ch.toFixed(1)+'g', dailyTotal.f.toFixed(1)+'g', dailyTotal.fib.toFixed(1)+'g']);

                    doc.autoTable({
                        startY: yPos + 2,
                        head: [['Food', 'Cals', 'P', 'C', 'F', 'Fib']],
                        body: tableRows,
                        theme: 'grid',
                        styles: { fontSize: 8 },
                        headStyles: { fillColor: [15, 23, 42] }
                    });
                    yPos = doc.lastAutoTable.finalY + 10;
                });

                // Section B: Weekly Averages
                doc.addPage();
                doc.setFontSize(14); doc.text("Weekly Performance Averages", 14, 20);
                const weeklyAgg = {};
                allNutrition.forEach(n => {
                    const wk = getWeekNumber(new Date(n.date));
                    if(!weeklyAgg[wk]) weeklyAgg[wk] = { c:0, p:0, ch:0, f:0, fib:0, v:0, days: new Set() };
                    weeklyAgg[wk].c += n.calories;
                    weeklyAgg[wk].p += n.protein;
                    weeklyAgg[wk].ch += n.carbs;
                    weeklyAgg[wk].f += n.fat;
                    weeklyAgg[wk].fib += (n.fiber||0);
                    weeklyAgg[wk].days.add(n.date);
                });
                allWorkouts.forEach(w => {
                    const wk = getWeekNumber(new Date(w.date));
                    if(weeklyAgg[wk]) weeklyAgg[wk].v += (Number(w.volume) || 0);
                });

                const weekRows = Object.keys(weeklyAgg).sort().reverse().map(wk => {
                    const w = weeklyAgg[wk];
                    const dCount = w.days.size || 1;
                    return [formatWeekLabel(wk), (w.c/dCount).toFixed(0), (w.p/dCount).toFixed(1)+'g', (w.ch/dCount).toFixed(1)+'g', (w.f/dCount).toFixed(1)+'g', (w.fib/dCount).toFixed(1)+'g', w.v.toLocaleString() + ' lbs'];
                });

                doc.autoTable({
                    startY: 30,
                    head: [['Week', 'Avg Cals', 'Avg P', 'Avg C', 'Avg F', 'Avg Fib', 'Total Lifted']],
                    body: weekRows,
                    headStyles: { fillColor: [132, 204, 22] }
                });

                // Section C: Graph
                const canvas = document.getElementById('trendChart') || chartRef.current;
                if (canvas) {
                    const chartImg = canvas.toDataURL("image/png");
                    doc.addPage();
                    doc.setFontSize(14); doc.text("Historical Weight & Calorie Trends", 14, 20);
                    doc.addImage(chartImg, 'PNG', 15, 30, 180, 90);
                }

                doc.save("Elite_Master_Report.pdf");
            };

            useEffect(() => {
                if (isScanning) {
                    setTimeout(() => {
                        const html5QrCode = new Html5Qrcode("reader");
                        scannerRef.current = html5QrCode;
                        const config = { fps: 10, qrbox: 250 };
                        html5QrCode.start({ facingMode: "environment" }, config, (decodedText) => { stopScanner(decodedText); }, (err) => {})
                        .catch(() => html5QrCode.start({ facingMode: "user" }, config, (decodedText) => { stopScanner(decodedText); }, ()=>{}));
                    }, 100); 
                }
                return () => { if(scannerRef.current && scannerRef.current.isScanning) scannerRef.current.stop().catch(()=>{}); }
            }, [isScanning]);

            const startScanner = () => { setResults([]); setIsScanning(true); };
            const stopScanner = (foundCode = null) => {
                if (scannerRef.current) {
                    scannerRef.current.stop().then(() => {
                        scannerRef.current.clear(); setIsScanning(false);
                        if (foundCode) { setQuery(foundCode); setTimeout(() => handleSearch(null, foundCode), 100); }
                    }).catch(() => setIsScanning(false));
                } else setIsScanning(false);
            };

            const changeDate = (offset) => {
                const d = new Date(currentDate);
                d.setDate(d.getDate() + offset);
                setCurrentDate(d.toISOString().split('T')[0]);
            };

            const saveEntry = async (exName, setIdx, reps, weight) => {
                if(!user || !reps || !weight) return;
                const entryId = `${currentDate}_${exName.replace(/\s+/g, '_')}_set${setIdx}`;
                await window.fb.setDoc(window.fb.doc(window.fb.db, "users", user.uid, "workout_logs", entryId), {
                    exercise: exName, setIndex: setIdx, reps: parseInt(reps), weight: parseFloat(weight), volume: parseInt(reps) * parseFloat(weight), date: currentDate, timestamp: window.fb.serverTimestamp()
                });
            };

            const addExerciseToRoutine = async (exerciseName) => {
                const newEx = { name: exerciseName, type: exerciseName.includes('Running') || exerciseName.includes('Cycling') ? 'cardio' : 'lifting', sets: 3 };
                const updatedRoutine = [...activeRoutine, newEx];
                await window.fb.setDoc(window.fb.doc(window.fb.db, "users", user.uid, "active_routines", currentDate), { exercises: updatedRoutine });
                setShowLibrary(false);
            };

            const removeExercise = async (idx) => {
                const updatedRoutine = activeRoutine.filter((_, i) => i !== idx);
                await window.fb.setDoc(window.fb.doc(window.fb.db, "users", user.uid, "active_routines", currentDate), { exercises: updatedRoutine });
            };

            const handleSearch = async (e, overrideQuery = null) => {
                if (e) e.preventDefault();
                const qTerm = overrideQuery || query;
                if (!qTerm) return;
                setLoading(true); setResults([]); setSelectedFood(null);
                if (/^\d+$/.test(qTerm)) {
                    try {
                        const res = await fetch(`https://api.nal.usda.gov/fdc/v1/foods/search?api_key=${API_KEY}&query=${qTerm}&pageSize=1&dataType=Branded,SR Legacy`);
                        const data = await res.json();
                        if (data.foods && data.foods.length > 0) { selectFood(data.foods[0]); setLoading(false); return; }
                    } catch (e) {}
                }
                try {
                    const res = await fetch(`https://api.nal.usda.gov/fdc/v1/foods/search?api_key=${API_KEY}&query=${qTerm}&pageSize=10&dataType=Foundation,SR Legacy,Branded`);
                    const data = await res.json();
                    if (data.foods) setResults(data.foods.map(f => ({ ...f, description: `(USDA) ${f.description}`, fdcId: f.fdcId })));
                } catch (e) {}
                setLoading(false);
            };

            const selectFood = async (food) => {
                setLoading(true);
                try {
                    const res = await fetch(`https://api.nal.usda.gov/fdc/v1/food/${food.fdcId}?api_key=${API_KEY}`);
                    const d = await res.json();
                    const getVal = (id) => { const n = d.foodNutrients.find(x => x.nutrient?.id === id || x.nutrientId === id); return n ? (n.amount || n.value) : 0; };
                    setSelectedFood({ name: d.description, calories: getVal(1008)||getVal(208), protein: getVal(1003)||getVal(203), carbs: getVal(1005)||getVal(205), fat: getVal(1004)||getVal(204), fiber: getVal(1079)||getVal(291), userGrams: 100 });
                    setResults([]); setQuery("");
                } catch (err) {}
                setLoading(false);
            };

            const submitManual = async (e) => {
                e.preventDefault();
                const p = parseFloat(manualForm.p)||0; const c = parseFloat(manualForm.c)||0; const f = parseFloat(manualForm.f)||0; const fib = parseFloat(manualForm.fib)||0;
                const cals = (p*4) + (c*4) + (f*9);
                await window.fb.addDoc(window.fb.collection(window.fb.db, "users", user.uid, "logs"), { name: manualForm.name || "Custom", grams: 0, calories: cals, protein: p, carbs: c, fat: f, fiber: fib, date: currentDate, time: new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }), createdAt: window.fb.serverTimestamp() });
                setShowManual(false); setManualForm({ name: "", p: "", c: "", f: "", fib: "" });
            };

            const addToLog = async () => {
                if(!selectedFood) return;
                const f = selectedFood.userGrams / 100;
                await window.fb.addDoc(window.fb.collection(window.fb.db, "users", user.uid, "logs"), { name: selectedFood.name, grams: selectedFood.userGrams, calories: selectedFood.calories * f, protein: parseFloat((selectedFood.protein * f).toFixed(1)), carbs: parseFloat((selectedFood.carbs * f).toFixed(1)), fat: parseFloat((selectedFood.fat * f).toFixed(1)), fiber: parseFloat((selectedFood.fiber * f).toFixed(1)), date: currentDate, time: new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }), createdAt: window.fb.serverTimestamp() });
                setSelectedFood(null);
            };

            const totalVolume = workoutLogs.reduce((acc, curr) => acc + (Number(curr.volume) || 0), 0);
            const nutritionTotals = nutritionLog.reduce((acc, i) => ({ cals: acc.cals + i.calories, pro: acc.pro + i.protein, carb: acc.carb + i.carbs, fat: acc.fat + i.fat, fib: acc.fib + (i.fiber||0) }), { cals: 0, pro: 0, carb: 0, fat: 0, fib: 0 });

            if (!user) return <AuthScreen />;

            return (
                <div className="max-w-4xl mx-auto px-4 pt-6 pb-24">
                    <div className="flex bg-brand-card rounded-2xl p-1 mb-6 border border-slate-700">
                        <button onClick={() => setAppMode("nutrition")} className={`flex-1 py-3 rounded-xl font-bold text-sm transition-all ${appMode === 'nutrition' ? 'bg-brand-green text-brand-navy' : 'text-slate-400'}`}>Nutrition</button>
                        <button onClick={() => setAppMode("workout")} className={`flex-1 py-3 rounded-xl font-bold text-sm transition-all ${appMode === 'workout' ? 'bg-brand-teal text-brand-navy' : 'text-slate-400'}`}>Elite Workout</button>
                    </div>

                    <div className="flex flex-col md:flex-row justify-between gap-4 mb-6">
                        <div className="flex items-center bg-brand-card p-2 rounded-xl border border-slate-700">
                            <button onClick={()=>changeDate(-1)} className="p-2 hover:text-brand-green">&lt;</button>
                            <span className="mx-4 font-bold min-w-[100px] text-center">{currentDate}</span>
                            <button onClick={()=>changeDate(1)} className="p-2 hover:text-brand-green">&gt;</button>
                        </div>
                        <div className="flex items-center bg-brand-input rounded-xl px-4 border border-slate-600">
                            <span className="text-xs text-slate-400 mr-2 uppercase tracking-tighter font-bold">LBS:</span>
                            <input type="number" value={dailyWeight} onChange={(e)=>setDailyWeight(e.target.value)} onBlur={async()=>await window.fb.setDoc(window.fb.doc(window.fb.db, "users", user.uid, "daily_stats", currentDate), { weight: dailyWeight, date: currentDate }, { merge: true })} className="bg-transparent text-white font-bold w-16 text-right outline-none" placeholder="0.0" />
                        </div>
                    </div>

                    {appMode === "nutrition" ? (
                        <div className="animate-fade">
                            <div className="flex justify-center gap-4 mb-6">
                                <button onClick={()=>setView('daily')} className={`text-xs px-4 py-1 rounded-full ${view==='daily' ? 'bg-brand-green text-brand-navy' : 'text-slate-400'}`}>Daily Log</button>
                                <button onClick={()=>setView('trends')} className={`text-xs px-4 py-1 rounded-full ${view==='trends' ? 'bg-brand-green text-brand-navy' : 'text-slate-400'}`}>Analytics</button>
                            </div>

                            {view === 'daily' ? (
                                <>
                                    <div className="grid grid-cols-2 md:grid-cols-5 gap-2 mb-6 text-center">
                                        <div className="bg-brand-card p-3 rounded-xl border border-slate-700 font-bold"><span className="text-[10px] text-slate-400 uppercase">Cals</span><div className={`text-lg ${nutritionTotals.cals > targets.calories ? 'text-red-400' : 'text-white'}`}>{Math.round(nutritionTotals.cals)}</div></div>
                                        <div className="bg-brand-card p-3 rounded-xl border border-slate-700 font-bold"><span className="text-[10px] text-brand-teal uppercase">P</span><div className="text-sm">{Math.round(nutritionTotals.pro)}g</div></div>
                                        <div className="bg-brand-card p-3 rounded-xl border border-slate-700 font-bold"><span className="text-[10px] text-brand-green uppercase">C</span><div className="text-sm">{Math.round(nutritionTotals.carb)}g</div></div>
                                        <div className="bg-brand-card p-3 rounded-xl border border-slate-700 font-bold"><span className="text-[10px] text-yellow-400 uppercase">F</span><div className="text-sm">{Math.round(nutritionTotals.fat)}g</div></div>
                                        <div className="bg-brand-card p-3 rounded-xl border border-slate-700 font-bold"><span className="text-[10px] text-purple-400 uppercase">Fib</span><div className="text-sm">{Math.round(nutritionTotals.fib)}g</div></div>
                                    </div>

                                    <div className="flex gap-2 mb-6 text-sm">
                                        <form onSubmit={handleSearch} className="flex-1 relative">
                                            <input type="text" value={query} onChange={e=>setQuery(e.target.value)} placeholder="Search food..." className="w-full p-4 bg-brand-input rounded-xl outline-none pr-12" />
                                            <button type="button" onClick={startScanner} className="absolute right-3 top-1/2 -translate-y-1/2 text-slate-400 hover:text-brand-green">
                                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z"/><circle cx="12" cy="13" r="3"/></svg>
                                            </button>
                                        </form>
                                        <button onClick={handleSearch} className="bg-brand-green text-brand-navy px-4 rounded-xl font-bold">Find</button>
                                        <button onClick={()=>setShowManual(!showManual)} className="bg-brand-card border border-slate-600 px-4 rounded-xl font-bold text-slate-300 text-sm">Custom</button>
                                    </div>

                                    {showManual && (
                                        <div className="bg-brand-card p-4 rounded-2xl border border-slate-600 mb-6 animate-fade">
                                            <h3 className="font-bold mb-4">Add Custom Food</h3>
                                            <form onSubmit={submitManual} className="grid grid-cols-2 md:grid-cols-5 gap-3">
                                                <input className="col-span-2 md:col-span-5 p-2 bg-brand-input rounded-lg text-white" placeholder="Food Name" required value={manualForm.name} onChange={e=>setManualForm({...manualForm, name: e.target.value})} />
                                                <input type="number" className="p-2 bg-brand-input rounded-lg text-white" placeholder="Protein" required value={manualForm.p} onChange={e=>setManualForm({...manualForm, p: e.target.value})} />
                                                <input type="number" className="p-2 bg-brand-input rounded-lg text-white" placeholder="Carbs" required value={manualForm.c} onChange={e=>setManualForm({...manualForm, c: e.target.value})} />
                                                <input type="number" className="p-2 bg-brand-input rounded-lg text-white" placeholder="Fat" required value={manualForm.f} onChange={e=>setManualForm({...manualForm, f: e.target.value})} />
                                                <input type="number" className="p-2 bg-brand-input rounded-lg text-white" placeholder="Fiber" value={manualForm.fib} onChange={e=>setManualForm({...manualForm, fib: e.target.value})} />
                                                <button type="submit" className="col-span-2 md:col-span-1 bg-brand-green text-brand-navy font-bold rounded-lg">Add</button>
                                            </form>
                                        </div>
                                    )}

                                    {results.length > 0 && (
                                        <div className="mt-4 bg-brand-card rounded-xl border border-slate-700 max-h-60 overflow-y-auto mb-6">
                                            {results.map(f => <div key={f.fdcId} onClick={()=>selectFood(f)} className="p-4 border-b border-slate-700 cursor-pointer hover:bg-slate-700">{f.description}</div>)}
                                        </div>
                                    )}

                                    {selectedFood && (
                                        <div className="mt-4 bg-brand-card p-5 rounded-2xl border border-brand-green mb-6 animate-fade">
                                            <p className="font-bold mb-4">{selectedFood.name}</p>
                                            <button onClick={addToLog} className="w-full bg-brand-green text-brand-navy py-4 rounded-xl font-black">Add 100g to Daily Log</button>
                                        </div>
                                    )}

                                    <div className="bg-brand-card rounded-2xl border border-slate-700 overflow-hidden">
                                        <table className="w-full text-xs text-left text-slate-300">
                                            <thead className="bg-slate-800 text-slate-400 uppercase">
                                                <tr><th className="px-4 py-3">Food</th><th className="px-4 py-3 text-brand-green">Cals</th><th className="px-4 py-3">P</th><th className="px-4 py-3">C</th><th className="px-4 py-3">F</th><th className="px-4 py-3">Fib</th><th className="px-4 py-3"></th></tr>
                                            </thead>
                                            <tbody>
                                                {nutritionLog.map(item => (
                                                    <tr key={item.id} className="border-b border-slate-700">
                                                        <td className="px-4 py-3 font-medium text-white max-w-[120px] truncate">{item.name}</td>
                                                        <td className="px-4 py-3 font-bold text-white">{item.calories.toFixed(0)}</td>
                                                        <td className="px-4 py-3 text-brand-teal">{item.protein.toFixed(1)}g</td>
                                                        <td className="px-4 py-3 text-brand-green">{item.carbs.toFixed(1)}g</td>
                                                        <td className="px-4 py-3 text-yellow-400">{item.fat.toFixed(1)}g</td>
                                                        <td className="px-4 py-3 text-purple-400">{item.fiber?.toFixed(1) || 0}g</td>
                                                        <td className="px-4 py-3 text-right"><button onClick={async()=>await window.fb.deleteDoc(window.fb.doc(window.fb.db,"users",user.uid,"logs",item.id))} className="text-red-400 p-1 font-bold">✕</button></td>
                                                    </tr>
                                                ))}
                                            </tbody>
                                        </table>
                                    </div>
                                </>
                            ) : (
                                <div className="space-y-6 animate-fade">
                                    <div className="grid grid-cols-2 gap-4 text-center">
                                        <div className="bg-brand-card p-6 rounded-2xl border border-slate-700"><span className="text-[10px] text-slate-400 uppercase tracking-widest">Adherence Score</span><div className="text-4xl font-extrabold text-brand-teal mt-2">{scores.adherence}%</div></div>
                                        <div className="bg-brand-card p-6 rounded-2xl border border-slate-700"><span className="text-[10px] text-slate-400 uppercase tracking-widest">Consistency Score</span><div className="text-4xl font-extrabold text-brand-green mt-2">{scores.consistency}%</div></div>
                                    </div>
                                    <div className="bg-brand-card p-4 rounded-2xl border border-slate-700 h-80">
                                        <canvas ref={chartRef} id="trendChart"></canvas>
                                    </div>
                                </div>
                            )}
                        </div>
                    ) : (
                        <div className="animate-fade">
                            <div className="bg-brand-card p-5 rounded-2xl border border-slate-700 mb-6 flex justify-between items-center">
                                <div><h2 className="text-xl font-black text-brand-teal uppercase tracking-tighter">Daily Volume</h2><p className="text-[10px] text-slate-500 font-bold uppercase">Dynamic Routine</p></div>
                                <div className="text-right font-black"><span className="text-2xl text-white">{totalVolume.toLocaleString()}</span><span className="ml-1 text-[10px] text-brand-teal uppercase">lbs</span></div>
                            </div>

                            <button onClick={() => setShowLibrary(true)} className="w-full py-4 bg-brand-navy border-2 border-dashed border-slate-600 rounded-2xl text-slate-400 font-bold mb-6 hover:border-brand-teal hover:text-brand-teal transition-all">+ Add Exercise from Library</button>

                            <div className="space-y-6">
                                {activeRoutine.map((ex, i) => {
                                    const exLogs = workoutLogs.filter(l => l.exercise === ex.name);
                                    return (
                                        <div key={i} className="bg-brand-card rounded-2xl p-5 border border-slate-700">
                                            <div className="flex justify-between items-center mb-4">
                                                <h3 className="font-extrabold text-white text-sm">{ex.name}</h3>
                                                <div className="flex gap-2">
                                                    <button onClick={() => setCustomSets(p => ({...p, [ex.name]: (p[ex.name]||0)+1}))} className="text-[9px] bg-slate-700 px-2 py-1 rounded font-bold uppercase">+ Set</button>
                                                    <button onClick={() => removeExercise(i)} className="text-[9px] bg-red-900/30 text-red-400 px-2 py-1 rounded font-bold uppercase">Remove</button>
                                                </div>
                                            </div>
                                            {ex.type === 'lifting' || ex.type === 'cardio' ? (
                                                <div className="space-y-4">
                                                    {[...Array(3 + (customSets[ex.name] || 0))].map((_, s) => {
                                                        const existing = exLogs.find(l => l.setIndex === s);
                                                        return (
                                                            <div key={s} className="grid grid-cols-2 gap-3 p-3 bg-slate-800/30 rounded-xl">
                                                                <div>
                                                                    <input type="number" placeholder="Reps" defaultValue={existing?.reps || ""} className="w-full bg-brand-input p-2 rounded-lg text-center text-sm outline-none font-bold" onBlur={(e) => { const wIn = e.target.closest('.grid').querySelector('input[placeholder="Lbs"]'); if(e.target.value && wIn.value) saveEntry(ex.name, s, e.target.value, wIn.value); }} />
                                                                    {workoutHistory[ex.name] && <p className="text-[8px] text-slate-500 mt-1 uppercase text-center">Last: {workoutHistory[ex.name].reps}</p>}
                                                                </div>
                                                                <div>
                                                                    <input type="number" placeholder="Lbs" defaultValue={existing?.weight || workoutHistory[ex.name]?.weight || ""} className="w-in w-full bg-brand-input p-2 rounded-lg text-center text-sm outline-none font-bold text-brand-teal" onBlur={(e) => { const rIn = e.target.closest('.grid').querySelector('input[placeholder="Reps"]'); if(e.target.value && rIn.value) saveEntry(ex.name, s, rIn.value, e.target.value); }} />
                                                                    {workoutHistory[ex.name] && <p className="text-[8px] text-slate-500 mt-1 uppercase text-center">Last: {workoutHistory[ex.name].weight}</p>}
                                                                </div>
                                                            </div>
                                                        );
                                                    })}
                                                </div>
                                            ) : null}
                                        </div>
                                    );
                                })}
                            </div>
                        </div>
                    )}

                    {showLibrary && (
                        <div className="fixed inset-0 z-[70] bg-black/95 p-4 overflow-y-auto">
                            <div className="max-w-md mx-auto bg-brand-card rounded-3xl border border-slate-700 p-6">
                                <div className="flex justify-between items-center mb-6">
                                    <h2 className="text-xl font-bold">Exercise Library</h2>
                                    <button onClick={() => setShowLibrary(false)} className="text-slate-400 font-bold text-lg">✕</button>
                                </div>
                                {Object.keys(WORKOUT_LIBRARY).map(cat => (
                                    <div key={cat} className="mb-6">
                                        <h4 className="text-[10px] text-slate-500 uppercase tracking-widest mb-3 font-bold">{cat}</h4>
                                        <div className="grid grid-cols-1 gap-2">
                                            {WORKOUT_LIBRARY[cat].map(ex => (
                                                <button key={ex} onClick={() => addExerciseToRoutine(ex)} className="w-full text-left p-3 bg-slate-800 rounded-xl hover:bg-brand-teal hover:text-brand-navy transition-all font-bold text-sm">{ex}</button>
                                            ))}
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </div>
                    )}

                    {isScanning && (
                        <div className="fixed inset-0 z-[60] bg-black/95 flex flex-col items-center justify-center p-4">
                            <div className="bg-brand-card p-6 rounded-3xl w-full max-w-sm border border-slate-700 relative">
                                <h3 className="text-center font-bold text-white mb-4">Scan Barcode</h3>
                                <div id="reader" className="w-full bg-black rounded-2xl overflow-hidden shadow-2xl"></div>
                                <button onClick={() => setIsScanning(false)} className="mt-6 w-full py-3 bg-red-500/20 text-red-400 rounded-xl font-bold uppercase text-xs">Cancel</button>
                            </div>
                        </div>
                    )}

                    <div className="fixed bottom-0 left-0 right-0 p-4 bg-brand-navy/90 flex gap-2 backdrop-blur-md border-t border-slate-800">
                        <button onClick={exportMasterReport} className="flex-1 bg-brand-green text-brand-navy font-black py-4 rounded-2xl uppercase tracking-tighter shadow-lg shadow-brand-green/20">Download Master Report (PDF)</button>
                        <button onClick={() => window.fb.signOut(window.fb.auth)} className="bg-slate-800 p-4 rounded-2xl text-red-400 font-bold">Exit</button>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
