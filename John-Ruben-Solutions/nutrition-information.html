<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>John Ruben Solutions - Advanced Tracker</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut, createUserWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, where, onSnapshot, deleteDoc, doc, setDoc, getDoc, orderBy, serverTimestamp, getDocs, writeBatch } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        
        const firebaseConfig = {
            apiKey: "AIzaSyD2h_sejv6lB8sFC15xHSgqxfdD2hLd5Kg",
            authDomain: "john-ruben-solutions.firebaseapp.com",
            projectId: "john-ruben-solutions",
            storageBucket: "john-ruben-solutions.firebasestorage.app",
            messagingSenderId: "761855596159",
            appId: "1:761855596159:web:a4bbe805663c2304c5d14a",
            measurementId: "G-1T2J8VR066"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        window.fb = { auth, db, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut, collection, addDoc, query, where, onSnapshot, deleteDoc, doc, setDoc, getDoc, getDocs, orderBy, serverTimestamp, writeBatch };
    </script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        brand: { navy: '#0f172a', dark: '#020617', card: '#1e293b', green: '#84cc16', teal: '#22d3ee', input: '#334155' }
                    },
                    fontFamily: { sans: ['"Plus Jakarta Sans"', 'sans-serif'] }
                }
            }
        }
    </script>
    <style> 
        body { background-color: #0f172a; color: #f8fafc; } 
        #reader video { object-fit: cover; border-radius: 12px; }
        .table-scroll::-webkit-scrollbar { height: 4px; width: 4px; }
        .table-scroll::-webkit-scrollbar-thumb { background: #84cc16; border-radius: 4px; }
        .table-scroll::-webkit-scrollbar-track { background: #1e293b; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;
        const API_KEY = '4FRpc4urF9W2UedPH6agara8y52PR0efkZRmoPvv'; 

        const getWeekNumber = (d) => {
            d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
            d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay() || 7));
            const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
            const weekNo = Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
            return `${d.getUTCFullYear()}-W${weekNo}`;
        };
        
        const formatWeekLabel = (weekStr) => {
             const parts = weekStr.split('-');
             return `Week ${parts[1]}, ${parts[0]}`;
        };

        const AuthScreen = () => {
            const [isRegister, setIsRegister] = useState(false);
            const [email, setEmail] = useState("");
            const [password, setPassword] = useState("");
            const [error, setError] = useState("");
            const handleSubmit = async (e) => {
                e.preventDefault(); setError("");
                if(!window.fb) return setError("Firebase loading...");
                try {
                    if (isRegister) await window.fb.createUserWithEmailAndPassword(window.fb.auth, email, password);
                    else await window.fb.signInWithEmailAndPassword(window.fb.auth, email, password);
                } catch (err) { setError(err.message); }
            };
            return (
                <div className="min-h-screen flex items-center justify-center p-4">
                    <div className="bg-brand-card p-8 rounded-3xl w-full max-w-sm border border-slate-700">
                        <h2 className="text-xl font-bold text-white mb-6 text-center">{isRegister ? "Create Account" : "Tracker Login"}</h2>
                        <form onSubmit={handleSubmit}>
                            <input type="email" placeholder="Email" className="w-full p-3 mb-4 bg-brand-input rounded-xl text-white outline-none focus:border-brand-green border border-transparent" value={email} onChange={e=>setEmail(e.target.value)} />
                            <input type="password" placeholder="Password" className="w-full p-3 mb-6 bg-brand-input rounded-xl text-white outline-none focus:border-brand-green border border-transparent" value={password} onChange={e=>setPassword(e.target.value)} />
                            {error && <p className="text-red-500 text-xs mb-4 text-center">{error}</p>}
                            <button type="submit" className="w-full py-3 bg-brand-green text-brand-navy font-bold rounded-xl">{isRegister ? "Sign Up" : "Log In"} </button>
                        </form>
                        <button onClick={()=>setIsRegister(!isRegister)} className="w-full mt-4 text-xs text-slate-400 hover:text-white underline">{isRegister ? "Already have an account? Log In" : "Need account? Sign Up"}</button>
                    </div>
                </div>
            );
        };

        const App = () => {
            const [user, setUser] = useState(null);
            const [profile, setProfile] = useState(null); // Stores gender, age, height, goal, etc.
            const [view, setView] = useState("daily");
            
            // Dynamic Targets State
            const [targets, setTargets] = useState({ calories: 2000, protein: 150, carbs: 200, fat: 60 });
            
            const [query, setQuery] = useState("");
            const [results, setResults] = useState([]);
            const [currentDate, setCurrentDate] = useState(new Date().toISOString().split('T')[0]);
            const [log, setLog] = useState([]);
            const [dailyWeight, setDailyWeight] = useState("");
            
            const [scores, setScores] = useState({ adherence: 0, consistency: 0 });
            const [showManual, setShowManual] = useState(false);
            const [manualForm, setManualForm] = useState({ name: "", p: "", c: "", f: "", fib: "" });
            const [selectedFood, setSelectedFood] = useState(null);
            const [displayAmount, setDisplayAmount] = useState(100);
            const [measureUnit, setMeasureUnit] = useState('g');
            const [isScanning, setIsScanning] = useState(false);
            const [loading, setLoading] = useState(false);
            
            const scannerRef = useRef(null);
            const chartRef = useRef(null);
            const chartInstance = useRef(null); 

            useEffect(() => {
                const check = setInterval(() => {
                    if (window.fb) {
                        clearInterval(check);
                        window.fb.onAuthStateChanged(window.fb.auth, (u) => {
                            setUser(u);
                            if(u) loadProfile(u.uid);
                        });
                    }
                }, 500);
                return () => clearInterval(check);
            }, []);

            // 1. Fetch Profile (Gender, Age, Height, Goal Settings)
            const loadProfile = async (uid) => {
                const docRef = window.fb.doc(window.fb.db, "users", uid, "data", "profile");
                const snap = await window.fb.getDoc(docRef);
                if (snap.exists()) {
                    setProfile(snap.data());
                }
                // Also try to load static targets as fallback
                const targetRef = window.fb.doc(window.fb.db, "users", uid, "data", "targets");
                const targetSnap = await window.fb.getDoc(targetRef);
                if (targetSnap.exists()) setTargets(targetSnap.data());
            };

            // 2. DYNAMIC CALCULATION ENGINE
            // Re-runs whenever Daily Weight or Profile changes
            useEffect(() => {
                if (profile && dailyWeight) {
                    const weightKg = parseFloat(dailyWeight) * 0.453592;
                    const heightCm = profile.height * (profile.height > 100 ? 1 : 2.54); // Assume profile stores in cm or in, detect? Usually calc stores in cm or raw. Let's assume Profile inputs: if height is small (<100) it's unlikely cm. Code from calc used inches->cm.
                    // Actually, the calculator stored inputs. Let's use the same logic as the calculator.
                    // Calculator logic: if input was inches, it stored raw. 
                    // Let's assume standard Metric for calculation to be safe, deriving from Profile data.
                    
                    // RE-DERIVING CONSTANTS from Profile Data
                    // Note: Profile stores raw inputs (e.g. height: 70). We need to know if it was in/cm. 
                    // To keep it simple and robust: The calculator previously saved "height" as the raw input number.
                    // We will estimate: if height < 100, assume inches. If > 100 assume cm.
                    
                    const h_cm = profile.height < 100 ? profile.height * 2.54 : profile.height;
                    const age = profile.age;
                    const gender = profile.gender;
                    const activity = profile.activity;
                    const goalAdj = profile.goal;
                    const bodyType = profile.bodyType || 'meso';

                    // BMR (Mifflin-St Jeor)
                    let bmr = (10 * weightKg) + (6.25 * h_cm) - (5 * age);
                    bmr = (gender === 'male') ? bmr + 5 : bmr - 161;

                    // TDEE & Target
                    const tdee = bmr * activity;
                    const targetCals = Math.round(tdee + goalAdj);

                    // Macro Ratios
                    let pRatio = 0.40, cRatio = 0.30, fRatio = 0.30;
                    if (bodyType === 'ecto') { pRatio = 0.30; cRatio = 0.50; fRatio = 0.20; }
                    else if (bodyType === 'endo') { pRatio = 0.40; cRatio = 0.20; fRatio = 0.40; }

                    let pGrams = Math.round((targetCals * pRatio) / 4);
                    const cGrams = Math.round((targetCals * cRatio) / 4);
                    let fGrams = Math.round((targetCals * fRatio) / 9);

                    // Protein Safety Floor (1.6g/kg)
                    const minPro = Math.round(1.6 * weightKg);
                    if (pGrams < minPro) {
                        pGrams = minPro;
                        // Recalculate fat/carb balance? Or just let calories float slightly? 
                        // Calculator logic was: set P to min, recalc C, dump rest in F.
                        const pCals = pGrams * 4;
                        const cCals = Math.round(targetCals * cRatio);
                        const fCals = targetCals - pCals - cCals;
                        fGrams = Math.max(0, Math.round(fCals / 9));
                    }

                    setTargets({
                        calories: targetCals,
                        protein: pGrams,
                        carbs: cGrams,
                        fat: fGrams
                    });
                }
            }, [dailyWeight, profile]);

            // DATA FETCHING
            useEffect(() => {
                if (!user || !window.fb) return;
                const q = window.fb.query(window.fb.collection(window.fb.db, "users", user.uid, "logs"), window.fb.where("date", "==", currentDate));
                const unsub = window.fb.onSnapshot(q, (snap) => {
                    const raw = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                    raw.sort((a,b) => (a.createdAt?.seconds || 0) - (b.createdAt?.seconds || 0)); 
                    setLog(raw);
                });
                
                const fetchWeight = async () => {
                    const docRef = window.fb.doc(window.fb.db, "users", user.uid, "daily_stats", currentDate);
                    const docSnap = await window.fb.getDoc(docRef);
                    setDailyWeight(docSnap.exists() ? docSnap.data().weight : "");
                };
                fetchWeight();
                return () => unsub();
            }, [user, currentDate]);

            useEffect(() => {
                if (view === 'trends' && user) {
                    setTimeout(calculateAnalytics, 200); 
                }
            }, [view, user]);

            const calculateAnalytics = async () => {
                if(!chartRef.current) return;
                const logSnap = await window.fb.getDocs(window.fb.collection(window.fb.db, "users", user.uid, "logs"));
                const weightSnap = await window.fb.getDocs(window.fb.collection(window.fb.db, "users", user.uid, "daily_stats"));
                
                const dailyData = {}; 
                logSnap.forEach(doc => {
                    const d = doc.data();
                    if(!dailyData[d.date]) dailyData[d.date] = { cals: 0, weight: null };
                    dailyData[d.date].cals += d.calories;
                });
                weightSnap.forEach(doc => {
                    const d = doc.data();
                    if(!dailyData[d.date]) dailyData[d.date] = { cals: 0, weight: null };
                    dailyData[d.date].weight = parseFloat(d.weight);
                });

                const dates = Object.keys(dailyData).sort();
                if (dates.length > 0) {
                    const firstDate = new Date(dates[0]);
                    const lastDate = new Date(dates[dates.length - 1]);
                    const diffTime = Math.abs(lastDate - firstDate);
                    const totalDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1; 
                    const loggedDays = dates.length;
                    const consistencyScore = totalDays > 0 ? Math.round((loggedDays / totalDays) * 100) : 0;

                    let adherenceDays = 0;
                    const target = targets.calories || 2000;
                    const range = target * 0.10; 
                    const minCal = target - range;
                    const maxCal = target + range;

                    dates.forEach(d => {
                        const intake = dailyData[d].cals;
                        if (intake >= minCal && intake <= maxCal) adherenceDays++;
                    });
                    
                    const adherenceScore = loggedDays > 0 ? Math.round((adherenceDays / loggedDays) * 100) : 0;
                    setScores({ adherence: adherenceScore, consistency: consistencyScore });
                }

                const weeklyData = {};
                Object.keys(dailyData).forEach(dateStr => {
                    const weekKey = getWeekNumber(new Date(dateStr));
                    if(!weeklyData[weekKey]) weeklyData[weekKey] = { totalCals: 0, daysWithCals: 0, totalWeight: 0, daysWithWeight: 0 };
                    
                    if(dailyData[dateStr].cals > 0) {
                        weeklyData[weekKey].totalCals += dailyData[dateStr].cals;
                        weeklyData[weekKey].daysWithCals++;
                    }
                    if(dailyData[dateStr].weight > 0) {
                        weeklyData[weekKey].totalWeight += dailyData[dateStr].weight;
                        weeklyData[weekKey].daysWithWeight++;
                    }
                });

                const sortedWeeks = Object.keys(weeklyData).sort(); 
                const labels = sortedWeeks.map(formatWeekLabel);
                const avgCals = sortedWeeks.map(w => weeklyData[w].daysWithCals ? weeklyData[w].totalCals / weeklyData[w].daysWithCals : 0);
                const avgWeights = sortedWeeks.map(w => weeklyData[w].daysWithWeight ? weeklyData[w].totalWeight / weeklyData[w].daysWithWeight : null);

                if (chartInstance.current) chartInstance.current.destroy();
                const ctx = chartRef.current.getContext('2d');
                chartInstance.current = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [
                            { label: 'Avg Calories', data: avgCals, borderColor: '#84cc16', yAxisID: 'y', tension: 0.3 },
                            { label: 'Avg Weight (lbs)', data: avgWeights, borderColor: '#22d3ee', yAxisID: 'y1', tension: 0.3 }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        interaction: { mode: 'index', intersect: false },
                        scales: {
                            y: { type: 'linear', display: true, position: 'left', title: {display: true, text:'Calories'} },
                            y1: { type: 'linear', display: true, position: 'right', grid: { drawOnChartArea: false }, title: {display: true, text:'Weight'} }
                        }
                    }
                });
            };

            const exportFullHistory = async () => {
                setView('trends');
                await new Promise(r => setTimeout(r, 1500)); 

                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                const navy = [15, 23, 42]; 
                
                const addFooter = (docPage) => {
                    const pageCount = docPage.internal.getNumberOfPages();
                    for (let i = 1; i <= pageCount; i++) {
                        docPage.setPage(i);
                        docPage.setFontSize(8);
                        docPage.setTextColor(150);
                        docPage.text("Disclaimer: All data in this report was entered by the user. Information is for educational purposes only.", 105, 285, { align: "center" });
                    }
                };

                doc.setFontSize(18); doc.setTextColor(...navy); doc.text("JOHN RUBEN SOLUTIONS", 14, 20);
                doc.setFontSize(12); doc.setTextColor(100); doc.text(`Full Nutrition & Performance Report`, 14, 28);
                
                let localAdherence = 0;
                let localConsistency = 0;
                
                const logSnap = await window.fb.getDocs(window.fb.collection(window.fb.db, "users", user.uid, "logs"));
                const weightSnap = await window.fb.getDocs(window.fb.collection(window.fb.db, "users", user.uid, "daily_stats"));
                const weights = {}; weightSnap.forEach(d => weights[d.id] = d.data().weight);

                const dailyData = {}; 
                logSnap.forEach(doc => {
                    const d = doc.data();
                    if(!dailyData[d.date]) dailyData[d.date] = { cals: 0 };
                    dailyData[d.date].cals += d.calories;
                });
                
                const dates = Object.keys(dailyData).sort();
                if (dates.length > 0) {
                    const firstDate = new Date(dates[0]);
                    const lastDate = new Date(dates[dates.length - 1]);
                    const diffTime = Math.abs(lastDate - firstDate);
                    const totalDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1; 
                    const loggedDays = dates.length;
                    localConsistency = totalDays > 0 ? Math.round((loggedDays / totalDays) * 100) : 0;

                    let adherenceDays = 0;
                    const target = targets.calories || 2000;
                    const range = target * 0.10; 
                    const minCal = target - range;
                    const maxCal = target + range;

                    dates.forEach(d => {
                        const intake = dailyData[d].cals;
                        if (intake >= minCal && intake <= maxCal) adherenceDays++;
                    });
                    localAdherence = loggedDays > 0 ? Math.round((adherenceDays / loggedDays) * 100) : 0;
                }

                doc.setFontSize(10); doc.setTextColor(0);
                doc.text(`Adherence Score: ${localAdherence}%`, 14, 38);
                doc.text(`Consistency Score: ${localConsistency}%`, 70, 38);

                const canvas = document.getElementById('trendChart');
                if (canvas) {
                    const imgData = canvas.toDataURL("image/png");
                    doc.addImage(imgData, 'PNG', 14, 45, 180, 80);
                }

                const rawLogs = [];
                logSnap.forEach(doc => rawLogs.push(doc.data()));
                rawLogs.sort((a, b) => new Date(b.date) - new Date(a.date));

                const grouped = {};
                rawLogs.forEach(d => {
                    if(!grouped[d.date]) grouped[d.date] = [];
                    grouped[d.date].push(d);
                });

                let finalY = 135; 

                const columnStyles = {
                    0: { cellWidth: 20 }, 
                    1: { cellWidth: 'auto' }, 
                    2: { cellWidth: 20, halign: 'right' },
                    3: { cellWidth: 15, halign: 'right', fontStyle: 'bold' },
                    4: { cellWidth: 15, halign: 'right' },
                    5: { cellWidth: 15, halign: 'right' },
                    6: { cellWidth: 15, halign: 'right' },
                    7: { cellWidth: 15, halign: 'right' }
                };

                Object.keys(grouped).forEach(date => {
                    if (finalY > 250) { doc.addPage(); finalY = 20; }
                    const items = grouped[date];
                    items.sort((a,b) => (a.time > b.time) ? 1 : -1);

                    const dayTotal = items.reduce((acc, i) => ({ cals: acc.cals + i.calories, pro: acc.pro + i.protein, carbs: acc.carbs + i.carbs, fat: acc.fat + i.fat }), { cals: 0, pro: 0, carbs: 0, fat: 0 });
                    
                    doc.setFontSize(10); doc.setTextColor(...navy); doc.setFont("helvetica", "bold");
                    doc.text(`Date: ${date}   |   Weight: ${weights[date] ? weights[date] + ' lbs' : 'N/A'}`, 14, finalY);
                    
                    const tableBody = items.map(i => [
                        i.time || '--',
                        i.name.substring(0, 30),
                        (i.grams > 0 ? parseFloat(i.grams).toFixed(1) : '-'),
                        parseFloat(i.calories).toFixed(1),
                        parseFloat(i.protein).toFixed(1),
                        parseFloat(i.carbs).toFixed(1),
                        parseFloat(i.fat).toFixed(1),
                        (i.fiber||0).toFixed(1)
                    ]);
                    
                    tableBody.push([
                        { content: 'DAILY TOTAL', colSpan: 3, styles: { fontStyle: 'bold', fillColor: [240, 240, 240] } },
                        dayTotal.cals.toFixed(1),
                        dayTotal.pro.toFixed(1),
                        dayTotal.carbs.toFixed(1),
                        dayTotal.fat.toFixed(1),
                        '-'
                    ]);

                    doc.autoTable({
                        startY: finalY + 2,
                        head: [['Time', 'Food', 'Qty', 'Cals', 'P', 'C', 'F', 'Fib']],
                        body: tableBody,
                        theme: 'grid',
                        headStyles: { fillColor: navy, fontSize: 8 },
                        bodyStyles: { fontSize: 8 },
                        columnStyles: columnStyles,
                        margin: { left: 14, right: 14 }
                    });
                    finalY = doc.lastAutoTable.finalY + 10;
                });

                if (finalY > 230) { doc.addPage(); finalY = 20; }
                
                doc.setFontSize(14);
                doc.text("Weekly Averages Summary", 14, finalY);
                
                const weeklyAgg = {};
                Object.keys(grouped).forEach(date => {
                    const week = getWeekNumber(new Date(date));
                    if(!weeklyAgg[week]) weeklyAgg[week] = { days: 0, cals: 0, pro: 0, carb: 0, fat: 0, fib: 0, weight: 0, wDays: 0 };
                    const items = grouped[date];
                    weeklyAgg[week].days++;
                    items.forEach(i => {
                        weeklyAgg[week].cals += i.calories;
                        weeklyAgg[week].pro += i.protein;
                        weeklyAgg[week].carb += i.carbs;
                        weeklyAgg[week].fat += i.fat;
                        weeklyAgg[week].fib += (i.fiber||0);
                    });
                    if(weights[date]) { weeklyAgg[week].weight += parseFloat(weights[date]); weeklyAgg[week].wDays++; }
                });

                const summaryBody = Object.keys(weeklyAgg).sort().map(w => {
                    const d = weeklyAgg[w];
                    const fmt = (val, target) => `${(val / d.days).toFixed(1)} / ${target}`;
                    
                    return [
                        formatWeekLabel(w),
                        fmt(d.cals, targets.calories),
                        fmt(d.pro, targets.protein + 'g'),
                        fmt(d.carb, targets.carbs + 'g'),
                        fmt(d.fat, targets.fat + 'g'),
                        fmt(d.fib, '45g'),
                        d.wDays ? (d.weight / d.wDays).toFixed(1) + ' lbs' : '-'
                    ];
                });

                doc.autoTable({
                    startY: finalY + 5,
                    head: [['Week', 'Cals (Act/Goal)', 'Pro (Act/Goal)', 'Carb (Act/Goal)', 'Fat (Act/Goal)', 'Fib (Act/Goal)', 'Avg Weight']],
                    body: summaryBody,
                    theme: 'striped',
                    headStyles: { fillColor: [132, 204, 22] }, 
                    styles: { fontSize: 8, cellPadding: 3, halign: 'center' },
                    headStyles: { halign: 'center', fillColor: [132, 204, 22] }
                });

                addFooter(doc);
                doc.save("Full_History_Report.pdf");
            };

            const saveWeight = async () => {
                if (!user) return;
                await window.fb.setDoc(window.fb.doc(window.fb.db, "users", user.uid, "daily_stats", currentDate), { weight: dailyWeight, date: currentDate }, { merge: true });
            };
            
            const hardReset = async () => {
                if(!confirm("Nutrition Information Says:\n\n⚠️ DANGER: Are you sure you want to delete ALL data? This action cannot be undone.")) return;
                if(!confirm("Final Confirmation: Do you want to wipe your entire history and start fresh?")) return;
                try {
                    setLoading(true);
                    const logsQ = window.fb.query(window.fb.collection(window.fb.db, "users", user.uid, "logs"));
                    const logsSnap = await window.fb.getDocs(logsQ);
                    const batch1 = window.fb.writeBatch(window.fb.db);
                    logsSnap.forEach(d => batch1.delete(d.ref));
                    await batch1.commit();

                    const statsQ = window.fb.query(window.fb.collection(window.fb.db, "users", user.uid, "daily_stats"));
                    const statsSnap = await window.fb.getDocs(statsQ);
                    const batch2 = window.fb.writeBatch(window.fb.db);
                    statsSnap.forEach(d => batch2.delete(d.ref));
                    await batch2.commit();

                    alert("All data has been cleared.");
                    setLog([]); setDailyWeight(""); setScores({ adherence: 0, consistency: 0 });
                    if(chartInstance.current) chartInstance.current.destroy();
                } catch(e) { console.error(e); alert("Error clearing data."); } finally { setLoading(false); }
            };

            const handleSearch = async (e, overrideQuery = null) => {
                if (e) e.preventDefault();
                const qTerm = overrideQuery || query;
                if (!qTerm) return;
                setLoading(true); setResults([]); setSelectedFood(null);

                // BARCODE
                if (/^\d+$/.test(qTerm)) {
                    try {
                        let res = await fetch(`https://api.nal.usda.gov/fdc/v1/foods/search?api_key=${API_KEY}&query=${qTerm}&pageSize=1&dataType=Branded,SR Legacy`);
                        let data = await res.json();
                        if (data.foods && data.foods.length > 0) { selectFood(data.foods[0]); setLoading(false); return; }
                        
                        res = await fetch(`https://world.openfoodfacts.org/api/v0/product/${qTerm}.json`);
                        data = await res.json();
                        if(data.status === 1) {
                             const p = data.product;
                             const n = p.nutriments;
                             setSelectedFood({
                                name: p.product_name,
                                calories: n['energy-kcal_100g'] || 0,
                                protein: n.proteins_100g || 0,
                                carbs: n.carbohydrates_100g || 0,
                                fat: n.fat_100g || 0,
                                fiber: n.fiber_100g || 0,
                                userGrams: 100
                             });
                             setQuery(""); setLoading(false); return;
                        }
                    } catch (e) {}
                }

                // TEXT
                try {
                    const res = await fetch(`https://api.nal.usda.gov/fdc/v1/foods/search?api_key=${API_KEY}&query=${qTerm}&pageSize=10&dataType=Foundation,SR Legacy,Branded`);
                    const data = await res.json();
                    setResults(data.foods);
                } catch (e) {}
                setLoading(false);
            };

            const selectFood = async (food) => {
                if (food.userGrams) return; 
                setLoading(true);
                const res = await fetch(`https://api.nal.usda.gov/fdc/v1/food/${food.fdcId}?api_key=${API_KEY}`);
                const d = await res.json();
                const getN = (id) => {
                    const n = d.foodNutrients.find(x => (x.nutrient?.id === id || x.nutrientId === id));
                    return n ? (n.amount || n.value) : 0;
                };
                setSelectedFood({
                    name: d.description,
                    calories: getN(1008) || getN(208),
                    protein: getN(1003) || getN(203),
                    carbs: getN(1005) || getN(205),
                    fat: getN(1004) || getN(204),
                    fiber: getN(1079) || getN(291),
                    userGrams: 100
                });
                setResults([]); setQuery("");
                setLoading(false);
            };

            const addToLog = async (manualItem = null) => {
                const item = manualItem || selectedFood;
                if(!item) return;
                
                let finalItem = {};
                
                if (manualItem) {
                    finalItem = {
                        ...manualItem,
                        date: currentDate,
                        time: new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }),
                        createdAt: window.fb.serverTimestamp()
                    }
                } else {
                    const f = item.userGrams / 100;
                    finalItem = {
                        name: item.name,
                        grams: item.userGrams,
                        calories: item.calories * f,
                        protein: parseFloat((item.protein * f).toFixed(1)),
                        carbs: parseFloat((item.carbs * f).toFixed(1)),
                        fat: parseFloat((item.fat * f).toFixed(1)),
                        fiber: parseFloat((item.fiber * f).toFixed(1)),
                        date: currentDate,
                        time: new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }),
                        createdAt: window.fb.serverTimestamp()
                    };
                }

                await window.fb.addDoc(window.fb.collection(window.fb.db, "users", user.uid, "logs"), finalItem);
                setSelectedFood(null);
                setShowManual(false);
                setManualForm({ name: "", p: "", c: "", f: "", fib: "" });
            };

            const deleteItem = async (id) => {
                if(confirm("Delete item?")) await window.fb.deleteDoc(window.fb.doc(window.fb.db, "users", user.uid, "logs", id));
            };

            const submitManual = (e) => {
                e.preventDefault();
                const p = parseFloat(manualForm.p)||0;
                const c = parseFloat(manualForm.c)||0;
                const f = parseFloat(manualForm.f)||0;
                const fib = parseFloat(manualForm.fib)||0;
                const cals = (p*4) + (c*4) + (f*9);
                
                addToLog({
                    name: manualForm.name || "Custom Food",
                    grams: 0,
                    calories: cals,
                    protein: p,
                    carbs: c,
                    fat: f,
                    fiber: fib
                });
            };

            const totals = log.reduce((acc, i) => ({
                cals: acc.cals + i.calories,
                pro: acc.pro + i.protein,
                carb: acc.carb + i.carbs,
                fat: acc.fat + i.fat,
                fib: acc.fib + (i.fiber||0)
            }), { cals: 0, pro: 0, carb: 0, fat: 0, fib: 0 });

            // --- SCANNER SETUP ---
            useEffect(() => {
                if (isScanning) {
                    const html5QrCode = new Html5Qrcode("reader");
                    scannerRef.current = html5QrCode;
                    
                    const config = { 
                        fps: 10, qrbox: { width: 250, height: 250 }, 
                        videoConstraints: { facingMode: { exact: "environment" } } 
                    };
                    const fallbackConfig = { fps: 10, qrbox: { width: 250, height: 250 }, videoConstraints: { facingMode: "environment" } };

                    html5QrCode.start({ facingMode: { exact: "environment" } }, config, (decodedText) => { 
                        stopScanner(decodedText); 
                    }, (err) => {}).catch(err => {
                        html5QrCode.start({ facingMode: "environment" }, fallbackConfig, (decodedText) => { stopScanner(decodedText); }, ()=>{});
                    });
                }
                return () => { if(scannerRef.current && scannerRef.current.isScanning) scannerRef.current.stop().catch(e=>{}); }
            }, [isScanning]);

            const startScanner = () => { setResults([]); setIsScanning(true); };
            const stopScanner = (foundCode = null) => {
                if (scannerRef.current) {
                    scannerRef.current.stop().then(() => {
                        scannerRef.current.clear();
                        setIsScanning(false);
                        if (foundCode) { setQuery(foundCode); setTimeout(() => handleSearch(null, foundCode), 100); }
                    }).catch(err => setIsScanning(false));
                } else setIsScanning(false);
            };

            const toggleUnit = () => {
                let nextUnit = measureUnit === 'g' ? 'oz' : measureUnit === 'oz' ? 'ml' : 'g';
                setMeasureUnit(nextUnit);
                let rawVal = parseFloat(displayAmount) || 0;
                let calculatedGrams = nextUnit === 'oz' ? rawVal * 28.3495 : rawVal;
                if (selectedFood) setSelectedFood({ ...selectedFood, userGrams: calculatedGrams });
            };

            const updateAmount = (val) => {
                setDisplayAmount(val);
                let rawVal = parseFloat(val) || 0;
                let calculatedGrams = measureUnit === 'oz' ? rawVal * 28.3495 : rawVal;
                if (selectedFood) setSelectedFood({ ...selectedFood, userGrams: calculatedGrams });
            };

            if (!user) return <AuthScreen />;

            return (
                <div className="max-w-4xl mx-auto px-4 pt-6 pb-20 font-sans text-white">
                    {/* TOP BAR */}
                    <div className="flex justify-between items-center mb-6 border-b border-slate-700 pb-4">
                        <h1 className="text-xl font-bold">Food Tracker</h1>
                        <div className="flex gap-4">
                            <button onClick={()=>setView('daily')} className={`text-xs px-3 py-1 rounded-full ${view==='daily' ? 'bg-brand-green text-brand-navy' : 'text-slate-400'}`}>Daily Log</button>
                            <button onClick={()=>setView('trends')} className={`text-xs px-3 py-1 rounded-full ${view==='trends' ? 'bg-brand-green text-brand-navy' : 'text-slate-400'}`}>Analytics</button>
                            <button onClick={() => window.fb.signOut(window.fb.auth)} className="text-xs text-red-400">Sign Out</button>
                        </div>
                    </div>

                    {/* MACRO DASHBOARD */}
                    <div className="grid grid-cols-2 md:grid-cols-6 gap-2 mb-6 text-center">
                        <div className="bg-brand-card p-3 rounded-xl border border-slate-700">
                            <span className="text-[10px] text-slate-400 uppercase">Calories</span>
                            <div className={`text-lg font-bold ${totals.cals > targets.calories ? 'text-red-400' : 'text-white'}`}>{Math.round(totals.cals)} / {targets.calories}</div>
                        </div>
                        <div className="bg-brand-card p-3 rounded-xl border border-slate-700">
                            <span className="text-[10px] text-brand-teal uppercase">Protein</span>
                            <div className="text-sm font-bold">{Math.round(totals.pro)} / {targets.protein}g</div>
                        </div>
                        <div className="bg-brand-card p-3 rounded-xl border border-slate-700">
                            <span className="text-[10px] text-brand-green uppercase">Carbs</span>
                            <div className="text-sm font-bold">{Math.round(totals.carb)} / {targets.carbs}g</div>
                        </div>
                        <div className="bg-brand-card p-3 rounded-xl border border-slate-700">
                            <span className="text-[10px] text-yellow-400 uppercase">Fat</span>
                            <div className="text-sm font-bold">{Math.round(totals.fat)} / {targets.fat}g</div>
                        </div>
                        <div className="bg-brand-card p-3 rounded-xl border border-slate-700">
                            <span className="text-[10px] text-purple-400 uppercase">Fiber</span>
                            <div className="text-sm font-bold">{Math.round(totals.fib)} / 45g</div>
                        </div>
                        <div className="bg-brand-card p-3 rounded-xl border border-slate-700">
                            <span className="text-[10px] text-slate-400 uppercase">Goal Weight</span>
                            <div className="text-sm font-bold">{profile ? profile.goalWeight + ' lbs' : '--'}</div>
                        </div>
                    </div>

                    {/* MAIN VIEW */}
                    {view === 'daily' ? (
                        <>
                            {/* DATE & WEIGHT */}
                            <div className="flex flex-col md:flex-row justify-between gap-4 mb-6">
                                <div className="flex items-center bg-brand-card p-2 rounded-xl border border-slate-700">
                                    <button onClick={()=>{const d=new Date(currentDate);d.setDate(d.getDate()-1);setCurrentDate(d.toISOString().split('T')[0])}} className="p-2 hover:text-brand-green">&lt;</button>
                                    <span className="mx-4 font-bold min-w-[100px] text-center">{currentDate}</span>
                                    <button onClick={()=>{const d=new Date(currentDate);d.setDate(d.getDate()+1);setCurrentDate(d.toISOString().split('T')[0])}} className="p-2 hover:text-brand-green">&gt;</button>
                                </div>
                                <div className="flex items-center bg-brand-input rounded-xl px-4 border border-slate-600">
                                    <span className="text-xs text-slate-400 mr-2 uppercase">TODAY'S WEIGHT:</span>
                                    <input type="number" value={dailyWeight} onChange={(e)=>setDailyWeight(e.target.value)} onBlur={saveWeight} className="bg-transparent text-white font-bold w-16 text-right focus:outline-none" placeholder="0.0" />
                                    <span className="text-xs text-brand-green ml-1">lbs</span>
                                </div>
                            </div>

                            {/* SEARCH BAR */}
                            <div className="flex gap-2 mb-6">
                                <div className="flex-1 relative">
                                    <form onSubmit={handleSearch} className="flex-1">
                                        <input type="text" value={query} onChange={e => setQuery(e.target.value)} placeholder="Search food..." className="w-full p-3 bg-brand-input rounded-xl text-white outline-none border border-transparent focus:border-brand-green pl-3 pr-10" />
                                    </form>
                                    <button onClick={startScanner} className="absolute right-2 top-1/2 -translate-y-1/2 text-slate-400 hover:text-brand-green p-2">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z"/><circle cx="12" cy="13" r="3"/></svg>
                                    </button>
                                </div>
                                <button onClick={handleSearch} className="bg-brand-green text-brand-navy px-6 rounded-xl font-bold hover:bg-white transition-colors">Find</button>
                                <button onClick={()=>setShowManual(!showManual)} className="bg-brand-card border border-slate-600 px-4 rounded-xl font-bold text-slate-300 hover:text-white">Custom</button>
                            </div>

                            {/* MANUAL ENTRY FORM */}
                            {showManual && (
                                <div className="bg-brand-card p-4 rounded-2xl border border-slate-600 mb-6 animate-fade">
                                    <h3 className="font-bold mb-3">Add Custom Food</h3>
                                    <form onSubmit={submitManual} className="grid grid-cols-2 md:grid-cols-5 gap-3">
                                        <input className="col-span-2 md:col-span-5 p-2 bg-brand-input rounded-lg text-white" placeholder="Food Name" required value={manualForm.name} onChange={e=>setManualForm({...manualForm, name: e.target.value})} />
                                        <input type="number" className="p-2 bg-brand-input rounded-lg text-white" placeholder="Protein (g)" required value={manualForm.p} onChange={e=>setManualForm({...manualForm, p: e.target.value})} />
                                        <input type="number" className="p-2 bg-brand-input rounded-lg text-white" placeholder="Carbs (g)" required value={manualForm.c} onChange={e=>setManualForm({...manualForm, c: e.target.value})} />
                                        <input type="number" className="p-2 bg-brand-input rounded-lg text-white" placeholder="Fat (g)" required value={manualForm.f} onChange={e=>setManualForm({...manualForm, f: e.target.value})} />
                                        <input type="number" className="p-2 bg-brand-input rounded-lg text-white" placeholder="Fiber (g)" value={manualForm.fib} onChange={e=>setManualForm({...manualForm, fib: e.target.value})} />
                                        <button type="submit" className="col-span-2 md:col-span-1 bg-brand-green text-brand-navy font-bold rounded-lg">Add</button>
                                    </form>
                                </div>
                            )}

                            {/* RESULTS LIST */}
                            {results.length > 0 && (
                                <div className="bg-brand-card rounded-xl border border-slate-700 mb-6 max-h-60 overflow-y-auto">
                                    {results.map(food => (
                                        <div key={food.fdcId} onClick={() => selectFood(food)} className="p-3 border-b border-slate-700 text-slate-300 hover:bg-slate-700 cursor-pointer transition-colors">
                                            {food.description}
                                        </div>
                                    ))}
                                </div>
                            )}
                            
                            {/* STAGING AREA */}
                            {selectedFood && (
                                <div className="bg-brand-card rounded-2xl border border-slate-700 p-4 mb-6 animate-fade">
                                    <div className="flex justify-between items-start mb-4">
                                        <h3 className="font-bold text-white text-lg flex-1 mr-2">{selectedFood.name}</h3>
                                        <button onClick={() => setSelectedFood(null)} className="text-slate-500 hover:text-white">x</button>
                                    </div>
                                    
                                    <div className="flex items-center justify-between mb-4 bg-brand-input rounded-xl p-2 border border-slate-600">
                                         <div className="flex items-center gap-2">
                                            <input type="number" value={displayAmount} onFocus={(e)=>setDisplayAmount('')} onChange={(e)=>updateAmount(e.target.value)} className="w-20 bg-transparent text-white font-bold text-2xl text-center focus:outline-none placeholder-slate-500" placeholder="0" />
                                            <button onClick={toggleUnit} className="px-3 py-1 bg-brand-card text-brand-green border border-brand-green rounded-lg font-bold text-xs uppercase hover:bg-brand-green hover:text-brand-navy transition-colors">{measureUnit}</button>
                                        </div>
                                        <div className="text-right">
                                            <span className="block text-2xl font-bold text-white">{Math.round(selectedFood.calories * (selectedFood.userGrams/100))}</span>
                                            <span className="text-[10px] text-slate-400 uppercase tracking-wider">Calories</span>
                                        </div>
                                    </div>
                                    
                                    <div className="grid grid-cols-3 gap-2 mb-4 text-center text-xs text-slate-300">
                                        <div className="bg-slate-800 p-2 rounded-lg">Pro: {(selectedFood.protein * (selectedFood.userGrams/100)).toFixed(1)}g</div>
                                        <div className="bg-slate-800 p-2 rounded-lg">Carb: {(selectedFood.carbs * (selectedFood.userGrams/100)).toFixed(1)}g</div>
                                        <div className="bg-slate-800 p-2 rounded-lg">Fat: {(selectedFood.fat * (selectedFood.userGrams/100)).toFixed(1)}g</div>
                                    </div>

                                    <button onClick={addToLog} className="w-full py-3 bg-brand-green text-brand-navy font-bold rounded-xl hover:bg-white transition-colors">Add to Daily Log</button>
                                </div>
                            )}

                            {/* LOG */}
                            <div className="bg-brand-card rounded-2xl border border-slate-700 overflow-hidden">
                                <div className="p-4 border-b border-slate-700 flex justify-between items-center bg-slate-800/50">
                                    <h3 className="font-bold text-white text-sm uppercase tracking-wide">Daily Log</h3>
                                    <button onClick={exportFullHistory} className="text-xs font-bold text-brand-navy bg-brand-green px-3 py-1 rounded-full hover:bg-white transition-colors">Download PDF</button>
                                </div>
                                <div className="max-h-[400px] overflow-y-auto">
                                    {log.map(item => (
                                        <div key={item.id} className="p-4 border-b border-slate-700 flex justify-between items-center hover:bg-slate-700/30 transition-colors">
                                            <div className="flex-1 pr-2">
                                                <div className="text-white text-sm font-bold leading-tight">{item.name}</div>
                                                <div className="text-xs text-brand-teal mt-1">
                                                    {Math.round(item.grams)}g <span className="text-slate-500">|</span> {Math.round(item.calories)} kcal <span className="text-slate-500">|</span> P: {Math.round(item.protein)}g
                                                </div>
                                            </div>
                                            <button onClick={() => deleteItem(item.id)} className="text-red-400 hover:text-red-300 p-2 transition-colors">x</button>
                                        </div>
                                    ))}
                                    {log.length === 0 && <div className="p-8 text-center text-slate-500 text-sm">No foods logged for {currentDate}.</div>}
                                </div>
                            </div>
                        </>
                    ) : (
                        /* TRENDS & SCORES */
                        <div className="space-y-6">
                            <div className="grid grid-cols-2 gap-4">
                                <div className="bg-brand-card p-6 rounded-2xl border border-slate-700 text-center relative group">
                                    <span className="text-xs text-slate-400 uppercase tracking-widest">Adherence Score</span>
                                    <div className="text-4xl font-extrabold text-brand-teal mt-2">{scores.adherence}%</div>
                                    <div className="text-[10px] text-slate-500 mt-2">Days within ±10% of calorie goal</div>
                                    
                                    <div className="absolute top-2 right-2 opacity-0 group-hover:opacity-100 transition-opacity bg-slate-800 p-2 rounded text-[10px] w-40 text-left z-10 border border-slate-600 pointer-events-none">
                                        Measures how often you land within 10% of your daily calorie target. Precision matters!
                                    </div>
                                </div>
                                <div className="bg-brand-card p-6 rounded-2xl border border-slate-700 text-center relative group">
                                    <span className="text-xs text-slate-400 uppercase tracking-widest">Consistency Score</span>
                                    <div className="text-4xl font-extrabold text-brand-green mt-2">{scores.consistency}%</div>
                                    <div className="text-[10px] text-slate-500 mt-2">Days tracked / Total days</div>
                                    
                                    <div className="absolute top-2 right-2 opacity-0 group-hover:opacity-100 transition-opacity bg-slate-800 p-2 rounded text-[10px] w-40 text-left z-10 border border-slate-600 pointer-events-none">
                                        Measures how often you log data. Missing days lowers this score. Consistency is key!
                                    </div>
                                </div>
                            </div>

                            <div className="bg-brand-card p-4 rounded-2xl border border-slate-700">
                                <h3 className="font-bold text-white mb-4">Weekly Trends</h3>
                                <div className="relative h-80 w-full">
                                    <canvas ref={chartRef} id="trendChart"></canvas>
                                </div>
                            </div>
                        </div>
                    )}
                    
                    {/* HARD RESET BUTTON */}
                    <div className="mt-12 pt-8 border-t border-slate-800 text-center">
                        <button onClick={hardReset} className="text-xs text-red-500 hover:text-red-400 font-bold uppercase tracking-widest border border-red-900/50 bg-red-900/10 px-6 py-3 rounded-xl transition-all hover:bg-red-900/30">
                            ⚠ Reset All Data
                        </button>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
