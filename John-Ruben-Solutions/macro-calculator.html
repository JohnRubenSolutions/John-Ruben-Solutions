<!DOCTYPE html>
<html lang="en">
<head>
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-J25PL1Z8SW"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-J25PL1Z8SW');
    </script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>John Ruben Solutions - Macro Calculator</title>

    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyD2h_sejv6lB8sFC15xHSgqxfdD2hLd5Kg",
            authDomain: "john-ruben-solutions.firebaseapp.com",
            projectId: "john-ruben-solutions",
            storageBucket: "john-ruben-solutions.firebasestorage.app",
            messagingSenderId: "761855596159",
            appId: "1:761855596159:web:a4bbe805663c2304c5d14a",
            measurementId: "G-1T2J8VR066"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Expose to window for vanilla JS calls
        window.fb = { auth, db, doc, setDoc, getDoc, signOut, createUserWithEmailAndPassword, signInWithEmailAndPassword };

        // Auth Listener
        onAuthStateChanged(auth, (user) => {
            if (user) {
                document.getElementById('auth-screen').classList.add('hidden');
                document.getElementById('app-screen').classList.remove('hidden');
                loadUserProfile(user.uid);
            } else {
                document.getElementById('auth-screen').classList.remove('hidden');
                document.getElementById('app-screen').classList.add('hidden');
            }
        });

        async function loadUserProfile(uid) {
            const docRef = doc(db, "users", uid, "data", "profile");
            const docSnap = await getDoc(docRef);
            if (docSnap.exists()) {
                const data = docSnap.data();
                document.getElementById('gender').value = data.gender;
                document.getElementById('age').value = data.age;
                document.getElementById('weight').value = data.weight;
                document.getElementById('height').value = data.height;
                document.getElementById('activity').value = data.activity;
                document.getElementById('goal').value = data.goal;
                // Auto calculate visually
                // calculate(); 
            }
        }
    </script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        brand: { navy: '#0f172a', card: '#1e293b', green: '#84cc16', teal: '#22d3ee', input: '#334155' }
                    },
                    fontFamily: { sans: ['"Plus Jakarta Sans"', 'sans-serif'] }
                }
            }
        }
    </script>
    
    <style>body { background-color: #0f172a; color: #f8fafc; }</style>
</head>
<body class="antialiased pb-20">

    <div id="auth-screen" class="min-h-screen flex flex-col items-center justify-center p-4">
        <div class="bg-brand-card p-8 rounded-3xl shadow-2xl w-full max-w-sm border border-slate-700">
            <h1 class="text-2xl font-bold text-white text-center mb-6">Macro Calculator Login</h1>
            <input type="email" id="email" placeholder="Email" class="w-full p-3 mb-4 bg-brand-input rounded-xl text-white outline-none focus:border-brand-green border border-transparent">
            <input type="password" id="password" placeholder="Password" class="w-full p-3 mb-6 bg-brand-input rounded-xl text-white outline-none focus:border-brand-green border border-transparent">
            <button onclick="handleLogin()" class="w-full py-3 bg-brand-green text-brand-navy font-bold rounded-xl mb-3">Log In</button>
            <button onclick="handleSignup()" class="w-full py-3 bg-brand-navy border border-slate-600 text-white font-bold rounded-xl">Sign Up</button>
            <p id="auth-error" class="text-red-500 text-xs text-center mt-4"></p>
        </div>
    </div>

    <div id="app-screen" class="hidden max-w-3xl mx-auto px-4 pt-10">
        <div class="flex justify-between items-center mb-8">
            <h1 class="text-2xl font-bold text-white">JOHN RUBEN</h1>
            <button onclick="window.fb.signOut(window.fb.auth)" class="text-xs text-slate-400 hover:text-white">Sign Out</button>
        </div>

        <div class="bg-brand-card rounded-[2rem] border border-slate-700 p-6 mb-8">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                <div>
                    <label class="text-xs font-bold text-slate-400 uppercase">Gender</label>
                    <select id="gender" class="w-full p-4 bg-brand-input rounded-xl text-white outline-none"><option value="male">Male</option><option value="female">Female</option></select>
                </div>
                <div>
                    <label class="text-xs font-bold text-slate-400 uppercase">Age</label>
                    <input type="number" id="age" value="35" class="w-full p-4 bg-brand-input rounded-xl text-white outline-none">
                </div>
                <div>
                    <label class="text-xs font-bold text-slate-400 uppercase">Weight (lbs)</label>
                    <input type="number" id="weight" value="155" class="w-full p-4 bg-brand-input rounded-xl text-white outline-none">
                </div>
                <div>
                    <label class="text-xs font-bold text-slate-400 uppercase">Goal Weight (lbs)</label>
                    <input type="number" id="goalWeight" value="145" class="w-full p-4 bg-brand-input rounded-xl text-white outline-none">
                </div>
                <div>
                    <label class="text-xs font-bold text-slate-400 uppercase">Height (in)</label>
                    <input type="number" id="height" value="66.5" class="w-full p-4 bg-brand-input rounded-xl text-white outline-none">
                </div>
            </div>

            <div class="mb-6">
                <label class="text-xs font-bold text-slate-400 uppercase">Activity</label>
                <select id="activity" class="w-full p-4 bg-brand-input rounded-xl text-white outline-none">
                    <option value="1.2">Sedentary</option><option value="1.55" selected>Moderate</option><option value="1.725">Active</option>
                </select>
            </div>

            <div class="mb-8">
                <label class="text-xs font-bold text-slate-400 uppercase">Goal</label>
                <select id="goal" class="w-full p-4 bg-brand-input rounded-xl text-white outline-none">
                    <option value="-500" selected>Lose Fast (-500)</option>
                    <option value="-250">Lose Slow (-250)</option>
                    <option value="0">Maintain</option>
                    <option value="250">Gain Slow (+250)</option>
                    <option value="500">Gain Fast (+500)</option>
                </select>
            </div>

            <button onclick="calculate()" class="w-full py-4 bg-brand-green text-brand-navy font-bold rounded-xl text-lg shadow-glow">GENERATE TARGETS</button>
        </div>

        <div id="results" class="hidden animate-up">
            <div class="bg-gradient-to-br from-slate-800 to-slate-900 border border-slate-700 text-white rounded-[2rem] p-8 text-center shadow-2xl mb-6 relative overflow-hidden">
                <div class="absolute top-0 right-0 w-64 h-64 bg-brand-teal rounded-full blur-[100px] opacity-10"></div>
                <span class="text-xs font-bold text-brand-green uppercase tracking-widest mb-2 block">Daily Ceiling</span>
                <div class="text-6xl font-extrabold mb-4" id="target-cal">0</div>
                
                <div id="timeline-container" class="bg-slate-800/50 rounded-xl p-4 border border-slate-600 mb-4 hidden">
                    <p class="text-xs font-bold text-brand-teal uppercase tracking-widest mb-1">Projected Timeline</p>
                    <p class="text-xl font-extrabold text-white" id="goal-date">Loading...</p>
                </div>
            </div>

            <div class="bg-brand-card rounded-[2rem] border border-slate-700 shadow-xl p-6 mb-6">
                <h3 class="text-lg font-bold text-white mb-6 text-center">Macro Split</h3>
                <div class="grid grid-cols-3 gap-3 mb-6">
                    <div class="bg-brand-navy border border-slate-700 rounded-2xl p-4 text-center"><span class="block text-2xl font-bold text-white" id="val-pro">0g</span><span class="text-[10px] text-brand-green uppercase">Protein</span></div>
                    <div class="bg-brand-navy border border-slate-700 rounded-2xl p-4 text-center"><span class="block text-2xl font-bold text-white" id="val-carb">0g</span><span class="text-[10px] text-brand-teal uppercase">Carbs</span></div>
                    <div class="bg-brand-navy border border-slate-700 rounded-2xl p-4 text-center"><span class="block text-2xl font-bold text-white" id="val-fat">0g</span><span class="text-[10px] text-yellow-400 uppercase">Fat</span></div>
                </div>

                <div class="flex flex-col gap-3 mb-6">
                    <a href="nutrition-tracker.html" class="block w-full py-3 text-center bg-brand-navy border border-brand-teal/30 rounded-xl hover:bg-brand-teal/10 text-brand-teal font-bold text-sm">ðŸ¥— Go to Nutrition Tracker</a>
                    <a href="drug-info.html" class="block w-full py-2 text-center text-xs text-slate-400 hover:text-white">ðŸ’Š Check Drug Interactions</a>
                </div>

                <button onclick="downloadPDF()" class="w-full mt-4 flex justify-center items-center gap-2 px-6 py-4 bg-brand-green text-brand-navy rounded-xl font-extrabold text-sm hover:bg-white transition-all">Download PDF Report</button>
            </div>
        </div>
    </div>

    <script>
        // Auth Handlers
        function handleLogin() {
            const e = document.getElementById('email').value;
            const p = document.getElementById('password').value;
            window.fb.signInWithEmailAndPassword(window.fb.auth, e, p).catch(err => document.getElementById('auth-error').innerText = err.message);
        }
        function handleSignup() {
            const e = document.getElementById('email').value;
            const p = document.getElementById('password').value;
            window.fb.createUserWithEmailAndPassword(window.fb.auth, e, p).catch(err => document.getElementById('auth-error').innerText = err.message);
        }

        // Calculation & Save Logic
        async function calculate() {
            const gender = document.getElementById('gender').value;
            const w = parseFloat(document.getElementById('weight').value);
            const gw = parseFloat(document.getElementById('goalWeight').value);
            const h = parseFloat(document.getElementById('height').value);
            const a = parseFloat(document.getElementById('age').value);
            const act = parseFloat(document.getElementById('activity').value);
            const goal = parseFloat(document.getElementById('goal').value);

            // Save to Firestore
            const user = window.fb.auth.currentUser;
            if (user) {
                try {
                    await window.fb.setDoc(window.fb.doc(window.fb.db, "users", user.uid, "data", "profile"), {
                        gender, weight: w, goalWeight: gw, height: h, age: a, activity: act, goal,
                        lastCalculated: new Date().toISOString()
                    });
                } catch (e) { console.error("Save error", e); }
            }

            // Math
            const kg = w * 0.453592;
            const cm = h * 2.54;
            let bmr = (10 * kg) + (6.25 * cm) - (5 * a);
            bmr = (gender === 'male') ? bmr + 5 : bmr - 161;
            const tdee = Math.round(bmr * act);
            const targetCal = tdee + goal;

            // Timeline
            const timelineContainer = document.getElementById('timeline-container');
            if (goal !== 0) {
                const diff = Math.abs(w - gw);
                const totalDeficit = diff * 3500;
                const days = totalDeficit / Math.abs(goal);
                const targetDate = new Date();
                targetDate.setDate(targetDate.getDate() + days);
                document.getElementById('goal-date').innerText = targetDate.toLocaleDateString();
                timelineContainer.classList.remove('hidden');
            } else {
                timelineContainer.classList.add('hidden');
            }

            // Macros (40/30/30)
            const p = Math.round((targetCal * 0.4) / 4);
            const c = Math.round((targetCal * 0.3) / 4);
            const f = Math.round((targetCal * 0.3) / 9);

            document.getElementById('target-cal').innerText = targetCal;
            document.getElementById('val-pro').innerText = p + "g";
            document.getElementById('val-carb').innerText = c + "g";
            document.getElementById('val-fat').innerText = f + "g";
            document.getElementById('results').classList.remove('hidden');
            
            // Save Targets for Tracker
            if (user) {
                await window.fb.setDoc(window.fb.doc(window.fb.db, "users", user.uid, "data", "targets"), {
                    calories: targetCal, protein: p, carbs: c, fat: f
                });
            }
        }

        function downloadPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            doc.text("Macronutrient Report", 20, 20);
            doc.text(`Calories: ${document.getElementById('target-cal').innerText}`, 20, 40);
            doc.save("MacroReport.pdf");
        }
    </script>
</body>
</html>
